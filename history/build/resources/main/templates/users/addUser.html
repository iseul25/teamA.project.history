<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원가입</title>
    <link rel="stylesheet" href="/css/signUp.css">
</head>

<body>
<header>
    <a href="/home">
        <img src="/img/mainLg2.png" alt="메인 로고">
    </a>
    <ul>
        <li><a href="">학습하기</a></li>
        <li><a href="">퀴즈풀기</a></li>
        <li><a href="/attend">출석하기</a></li>
        <li><a href="">포인트 상점</a></li>
        <li><a href="/faq">FAQ</a></li>
        <li><a href="">공지사항</a></li>
    </ul>
</header>

<div id="container">
    <div id="signUpBox">
        <h1>회 원 가 입</h1>

        <!-- Thymeleaf 폼과 객체 바인딩 -->
        <form th:action="@{/user/add}" th:object="${user}" method="post">
            <div id="userDataBox">
                <p>ID</p>
                <div id="input-wrapper">
                    <input type="text" id="email" th:field="*{email}" placeholder="abc123@gmail.com">
                    <button type="button" id="checkBtn" onclick="checkEmail()">중복확인</button>
                </div>
                <div id="emailMsg" class="msg"></div>

                <p>PASSWORD</p>
                <div id="pw-wrapper">
                    <input type="password" id="pw" th:field="*{password}" placeholder="*******">
                    <button type="button" id="togglePw" onclick="togglePassword()">👁</button>
                </div>
                <div id="pwMsg" class="msg"></div>

                <p>NAME</p>
                <input type="text" id="name" th:field="*{name}" placeholder="홍길동">
                <div id="nameMsg" class="msg"></div>
            </div>

            <div id="suBtnBox">
                <button id="suBtn" type="submit" onclick="return validateForm()">가입하기</button>
            </div>
        </form>
    </div>
</div>

<!-- Thymeleaf 에러 메시지 출력 -->
<div th:if="${errorMessage}" th:text="${errorMessage}" class="error-message"></div>

<div id="footer">
    <ul>
        <li>대표전화: 042-222-2402</li>
        <li>주소: (34838) 대전 중구 중앙로121번길 20(방산빌딩 3층)</li>
        <li>운영시간: 평일 09:00 ~ 18:00 (주말·공휴일 휴무)</li>
        <li>© 2025 역사 한 걸음. All rights reserved.</li>
    </ul>
</div>

<script>
    let emailChecked = false;

    // 비밀번호 표시/숨기기 토글
    function togglePassword() {
        const pwInput = document.getElementById("pw");
        const toggleBtn = document.getElementById("togglePw");

        if (pwInput.type === "password") {
            pwInput.type = "text";
            toggleBtn.textContent = "🙈";
        } else {
            pwInput.type = "password";
            toggleBtn.textContent = "👁";
        }
    }

    // 이메일 중복 확인
    async function checkEmail() {
        const emailInput = document.getElementById("email");
        const emailMsg = document.getElementById("emailMsg");
        const email = emailInput.value.trim();

        if (!email) {
            emailMsg.textContent = "이메일을 입력해주세요.";
            emailMsg.className = "msg error";
            emailInput.classList.add("error-text");
            emailChecked = false; // 필수: 유효성 검사 실패 시 false 설정
            return;
        }

        // 이메일 형식 검증
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            emailMsg.textContent = "올바른 이메일 형식이 아닙니다.";
            emailMsg.className = "msg error";
            emailInput.classList.add("error-text");
            emailChecked = false; // 필수: 유효성 검사 실패 시 false 설정
            return;
        }

        try {
            // 이메일 중복 확인 API 요청
            const res = await fetch(`/user/check-email?email=${encodeURIComponent(email)}`);
            const data = await res.json();

            if (data.available) {
                emailMsg.textContent = "사용 가능한 이메일입니다.";
                emailMsg.className = "msg success";
                emailInput.classList.remove("error-text");
                emailChecked = true; // 필수: 사용 가능할 때 true로 설정
            } else {
                emailMsg.textContent = "이미 사용 중인 이메일입니다.";
                emailMsg.className = "msg error";
                emailInput.classList.add("error-text");
                emailChecked = false; // 필수: 사용 중일 때 false로 설정
            }
        } catch (err) {
            console.error("이메일 중복 확인 중 서버 오류 발생:", err);
            emailMsg.textContent = "서버 오류가 발생했습니다. 다시 시도해 주세요.";
            emailMsg.className = "msg error";
            emailInput.classList.add("error-text");
            emailChecked = false; // 필수: 오류 발생 시 false로 설정
        }
    }

    // 이메일 입력값 변경 시 중복확인 상태 초기화
    document.getElementById("email").addEventListener("input", function() {
        const emailMsg = document.getElementById("emailMsg");
        emailMsg.textContent = "";
        emailMsg.className = "msg";
        this.classList.remove("error-text");
        emailChecked = false; // 입력값이 변경되면 상태를 false로 초기화
    });

    // 폼 유효성 검사
    function validateForm() {
        const email = document.getElementById("email").value.trim();
        const pw = document.getElementById("pw").value.trim();
        const name = document.getElementById("name").value.trim();

        const emailMsg = document.getElementById("emailMsg");
        const pwMsg = document.getElementById("pwMsg");
        const nameMsg = document.getElementById("nameMsg");

        // 메시지 초기화
        emailMsg.textContent = "";
        pwMsg.textContent = "";
        nameMsg.textContent = "";

        let isValid = true;

        // 이메일 체크
        if (email === "") {
            emailMsg.textContent = "이메일을 입력하세요.";
            emailMsg.className = "msg error";
            isValid = false;
        } else if (!emailChecked) {
            emailMsg.textContent = "이메일 중복확인을 해주세요.";
            emailMsg.className = "msg error";
            isValid = false;
        }

        // 비밀번호 체크
        if (pw === "") {
            pwMsg.textContent = "비밀번호를 입력하세요.";
            pwMsg.className = "msg error";
            isValid = false;
        } else if (pw.length < 6) {
            pwMsg.textContent = "비밀번호는 6자 이상이어야 합니다.";
            pwMsg.className = "msg error";
            isValid = false;
        }

        // 이름 체크
        if (name === "") {
            nameMsg.textContent = "이름을 입력하세요.";
            nameMsg.className = "msg error";
            isValid = false;
        }

        return isValid;
    }

    // 실시간 유효성 검사 (선택적)
    document.getElementById("pw").addEventListener("input", function() {
        const pwMsg = document.getElementById("pwMsg");
        if (this.value.length > 0 && this.value.length < 6) {
            pwMsg.textContent = "비밀번호는 6자 이상이어야 합니다.";
            pwMsg.className = "msg error";
        } else {
            pwMsg.textContent = "";
            pwMsg.className = "msg";
        }
    });

    document.getElementById("name").addEventListener("input", function() {
        const nameMsg = document.getElementById("nameMsg");
        if (this.value.trim() === "") {
            nameMsg.textContent = "이름을 입력하세요.";
            nameMsg.className = "msg error";
        } else {
            nameMsg.textContent = "";
            nameMsg.className = "msg";
        }
    });
</script>
</body>
</html>