<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>학습 게시글 관리</title>
    <link rel="stylesheet" th:href="@{/css/adminBoardList.css}">
    <link rel="preconnect" href="https://www.youtube.com">
    <link rel="preconnect" href="https://img.youtube.com">
</head>

<body>
<header>
    <a th:href="@{/}"><img th:src="@{/img/mainLg2.png}" alt="메인 로고"></a>
    <ul>
        <li><a th:href="@{/board/topic}">학습하기</a></li>
        <li><a th:href="@{/quiz/topic}">퀴즈풀기</a></li>
        <li><a th:href="@{/attend}">출석하기</a></li>
        <li><a th:href="@{/pointStore}">포인트 상점</a></li>
        <li><a th:href="@{/faq}">FAQ</a></li>
        <li><a th:href="@{/notice}">공지사항</a></li>
    </ul>
    <div id="user" th:if="${session.loginUser != null}">
        <a th:href="@{/admin/board}" th:if="${session.loginUser.userType == 'admin'}"
           id="userName-link" class="active"
           th:text="${session.loginUser.name} + '관리자님'"></a>
        <a th:href="@{/mypage}" th:unless="${session.loginUser.userType == 'admin'}"
           class="active"
           th:text="${session.loginUser.name} + '님'"></a>
    </div>
    <script th:if="${session.loginUser == null}" th:inline="javascript">
        window.location.href = '/login';
    </script>
</header>

<div id="sidebar">
    <ul>
        <li><a th:href="@{/admin/users}">회원관리</a></li>
        <li class="submenuBox">
            <a th:href="@{/admin/board}" class="active">게시글관리</a>
            <ul class="submenu">
                <li><a th:href="@{/admin/board}" class="active">학습하기</a></li>
                <li><a th:href="@{/admin/quiz}">퀴즈풀기</a></li>
                <li><a th:href="@{/admin/notice}">공지사항</a></li>
            </ul>
        </li>
        <li><a th:href="@{/admin/comment}">댓글관리</a></li>
        <li><a th:href="@{/admin/pointStore}">상점관리</a></li>
    </ul>
</div>

<div id="container">
    <div class="boardBox">
        <div id="board-title-box">
            <div class="board-title">학습하기</div>
            <button class="add-board-btn" id="openAddModal">게시글 등록</button>
        </div>

        <div th:if="${param.success}" class="alert success" th:text="${param.success[0]}"></div>
        <div th:if="${param.error}" class="alert error" th:text="'오류: ' + ${param.error[0]}"></div>

        <table class="board-table">
            <thead>
            <tr>
                <th style="width: 100px;">번호</th>
                <th id="categoryHeader" style="width: 190px;">
                    카테고리
                    <span class="dropdown-arrow">▼</span>
                    <ul id="categoryMenu" class="dropdown">
                        <li><a th:href="@{/admin/board(boardType='전체', page=0)}" data-category="전체">전체</a></li>
                        <li><a th:href="@{/admin/board(boardType='선사시대', page=0)}" data-category="선사시대">선사시대</a></li>
                        <li><a th:href="@{/admin/board(boardType='고조선과 여러 나라', page=0)}" data-category="고조선과 여러 나라">고조선과 여러 나라</a></li>
                        <li><a th:href="@{/admin/board(boardType='삼국과 가야', page=0)}" data-category="삼국과 가야">삼국과 가야</a></li>
                        <li><a th:href="@{/admin/board(boardType='남북극시대', page=0)}" data-category="남북극시대">남북극시대</a></li>
                        <li><a th:href="@{/admin/board(boardType='고려시대', page=0)}" data-category="고려시대">고려시대</a></li>
                        <li><a th:href="@{/admin/board(boardType='조선시대', page=0)}" data-category="조선시대">조선시대</a></li>
                        <li><a th:href="@{/admin/board(boardType='근대', page=0)}" data-category="근대">근대</a></li>
                        <li><a th:href="@{/admin/board(boardType='현대', page=0)}" data-category="현대">현대</a></li>
                    </ul>
                </th>
                <th>제목</th>
                <th style="width: 150px;">등록 일자</th>
                <th style="width: 80px;">작업</th>
            </tr>
            </thead>

            <tbody id="board-body">
            <tr th:each="board, stat : ${boards}">
                <td th:text="${(currentPage != null ? currentPage : 0) * 10 + stat.count}">1</td>
                <td th:text="${board.boardType}">학습</td>
                <td>
                    <span class="board-link" th:text="${board.title}"
                          th:onclick="'viewBoard(' + ${board.boardId} + ')'"></span>
                    <span th:if="${board.videoUrl}" style="margin-left:6px; font-size:12px; color:#e53935;">▶︎영상</span>
                </td>
                <td th:text="${#dates.format(board.created, 'yyyy-MM-dd')}">2025-01-01</td>
                <td>
                    <button th:onclick="'editBoard(' + ${board.boardId} + ')'" class="editBtn">수정</button>
                    <button th:onclick="'deleteBoard(' + ${board.boardId} + ')'" class="deleteBtn">삭제</button>
                </td>
            </tr>

            <th:block th:if="${boards != null and #lists.size(boards) < 10}">
                <tr th:each="i : ${#numbers.sequence(1, 10 - #lists.size(boards))}">
                    <td>&nbsp;</td><td></td><td></td><td></td><td></td>
                </tr>
            </th:block>

            <tr th:if="${#lists.isEmpty(boards)}">
                <td colspan="5" style="text-align: center; padding: 50px;">등록된 게시글이 없습니다.</td>
            </tr>
            </tbody>
        </table>

        <!-- ================== 등록 모달 ================== -->
        <div id="addBoardModal" class="modal">
            <div class="modal-content">
                <span class="closeAddBtn">&times;</span>
                <h2>게시글 등록</h2>
                <form id="addBoardForm" enctype="multipart/form-data">
                    <div id="addBoardType-box">
                        <label>카테고리</label>
                        <select id="addBoardType" name="boardType" required>
                            <option value="">선택</option>
                            <option value="선사시대">선사시대</option>
                            <option value="고조선과 여러 나라">고조선과 여러 나라</option>
                            <option value="삼국과 가야">삼국과 가야</option>
                            <option value="남북극시대">남북극시대</option>
                            <option value="고려시대">고려시대</option>
                            <option value="조선시대">조선시대</option>
                            <option value="근대">근대</option>
                            <option value="현대">현대</option>
                        </select>
                    </div>

                    <input type="text" name="title" placeholder="제목" required>

                    <textarea name="content" placeholder="내용" required></textarea>

                    <div id="addImage-box">
                        <label>이미지 업로드</label>
                        <div id="addImagePreview"><p style="margin:0; color:#666;">등록된 이미지가 없습니다.</p></div>
                        <input type="file" id="addImageFile" name="imageFile" accept="image/*">
                        <input type="text" name="imgDescription" placeholder="이미지 설명 (선택)">
                    </div>
                    <div class="video-field">
                        <label>유튜브 URL</label>
                        <input type="url" name="videoUrl" placeholder="https://youtu.be/XXXX 또는 https://www.youtube.com/watch?v=XXXX"><br>
                        <small style="color:#666;">썸네일만 먼저 보여주고, 클릭 시 재생합니다.</small>
                        <div class="video-preview" style="margin-top:10px; display:none;">
                            <button type="button" class="thumb-btn"
                                    style="padding:0;border:0;background:none;cursor:pointer;position:relative;">
                                <img class="thumb" alt="video thumbnail"
                                     style="max-width:560px;max-height:315px;display:block;">
                                <div style="position:absolute;bottom:10px;left:10px;font-size:16px;background:rgba(0,0,0,.6);color:#fff;padding:6px 10px;border-radius:6px;">
                                    ▶ 재생
                                </div>
                            </button>
                            <div class="iframe-host" style="margin-top:8px;"></div>
                        </div>
                    </div>
                    <button type="submit">등록 완료</button>
                </form>
            </div>
        </div>

        <!-- ================== 수정 모달 ================== -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <span class="closeEditBtn">&times;</span>
                <h2>게시글 수정</h2>
                <form id="editForm" th:action="@{/admin/board/edit}" method="post" enctype="multipart/form-data">
                    <input type="hidden" id="editBoardId" name="id" />
                    <input type="hidden" name="page" th:value="${currentPage}" />
                    <input type="hidden" name="boardType" th:value="${currentBoardType}" />
                    <input type="text" id="editTitle" name="title" placeholder="제목" required>
                    <textarea id="editContent" name="content" placeholder="내용" required></textarea>

                    <div class="image-upload-section">
                        <label for="editImageFile">이미지 업로드:</label>
                        <div id="currentImagePreview"></div>
                        <input type="file" id="editImageFile" name="imageFile" accept="image/*">
                        <input type="text" id="editImgDescription" name="imgDescription" placeholder="이미지 설명 (선택)">
                    </div>

                    <div class="video-field">
                        <label>유튜브 URL</label>
                        <input type="url" name="videoUrl"
                               placeholder="https://youtu.be/XXXXXXXXXXX 또는 https://www.youtube.com/watch?v=XXXXXXXXXXX"><br>
                        <small style="color:#666;">썸네일만 먼저 보여주고, 클릭 시 재생합니다.</small>
                        <div class="video-preview" style="margin-top:10px; display:none;">
                            <button type="button" class="thumb-btn"
                                    style="padding:0;border:0;background:none;cursor:pointer;position:relative;">
                                <img class="thumb" alt="video thumbnail"
                                     style="max-width:560px;max-height:315px;display:block;">
                                <div style="position:absolute;bottom:10px;left:10px;font-size:16px;background:rgba(0,0,0,.6);color:#fff;padding:6px 10px;border-radius:6px;">
                                    ▶ 재생
                                </div>
                            </button>
                            <div class="iframe-host" style="margin-top:8px;"></div>
                        </div>
                    </div>

                    <button type="submit" id="editBoard-btn">수정 완료</button>
                </form>
            </div>
        </div>

        <!-- ================== 상세보기 모달 ================== -->
        <div id="viewModal" class="modal">
            <div class="modal-content">
                <span class="closeViewBtn">&times;</span>
                <h2>게시글 상세보기</h2>
                <div class="view-form">
                    <div class="form-group">
                        <div id="viewTitle" class="view-field"></div>
                    </div>
                    <div class="form-group">
                        <div id="viewContent" class="view-content"></div>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button type="button" onclick="closeViewModal()">닫기</button>
                </div>
            </div>
        </div>

        <!-- ================== 페이징 ================== -->
        <div id="pagination" class="pagination" th:if="${totalPages > 0}">
            <a th:if="${currentPage > 0}"
               th:href="@{/admin/board(page=${currentPage - 1}, boardType=${currentBoardType})}"
               class="page-btn">◀</a>
            <span th:unless="${currentPage > 0}" class="page-btn disabled">◀</span>

            <th:block th:each="i : ${#numbers.sequence(0, totalPages - 1)}">
                <a th:unless="${i == currentPage}"
                   th:href="@{/admin/board(page=${i}, boardType=${currentBoardType})}"
                   th:text="${i + 1}"
                   class="page-btn"></a>
                <span th:if="${i == currentPage}"
                      th:text="${i + 1}"
                      class="page-btn active"></span>
            </th:block>

            <a th:if="${currentPage < totalPages - 1}"
               th:href="@{/admin/board(page=${currentPage + 1}, boardType=${currentBoardType})}"
               class="page-btn">▶</a>
            <span th:unless="${currentPage < totalPages - 1}" class="page-btn disabled">▶</span>
        </div>
    </div>
</div>

<div id="footer">
    <ul>
        <li>대표전화: 042-222-2402</li>
        <li>주소: (34838) 대전 중구 중앙로121번길 20(방산빌딩 3층)</li>
        <li>운영시간: 평일 09:00 ~ 18:00 (주말·공휴일 휴무)</li>
        <li>© 2025 역사 한 걸음. All rights reserved.</li>
    </ul>
</div>

<script>
    // ================= 유튜브 유틸리티 ================
    (function(){
        const ID_RE = /(?:youtu\.be\/|youtube\.com\/(?:watch\?v=|embed\/|shorts\/))([A-Za-z0-9_-]{11})/;
        function ytExtractId(url){ const m = String(url||'').trim().match(ID_RE); return m ? m[1] : null; }
        function ytThumb(id){ return `https://img.youtube.com/vi/${id}/hqdefault.jpg`; }
        function ytEmbed(id){ return `https://www.youtube.com/embed/${id}`; }
        function embedToShare(embedUrl){ const m = String(embedUrl||'').match(/embed\/([A-Za-z0-9_-]{11})/); return m ? `https://youtu.be/${m[1]}` : ''; }

        window.bindVideoField = function(root){
            if (!root || root.dataset.bound === '1') return;
            root.dataset.bound = '1';

            const input = root.querySelector('input[name="videoUrl"]');
            const wrap = root.querySelector('.video-preview');
            const btn = root.querySelector('.thumb-btn');
            const img = root.querySelector('.thumb');
            const host = root.querySelector('.iframe-host');
            let t;

            if (!input || !wrap || !btn || !img || !host) return;

            input.addEventListener('input', function(){
                clearTimeout(t);
                t = setTimeout(function(){
                    const id = ytExtractId(input.value);
                    if (id){
                        img.src = ytThumb(id);
                        wrap.style.display = 'block';
                        host.innerHTML = '';
                    } else {
                        wrap.style.display = 'none';
                        img.removeAttribute('src');
                        host.innerHTML = '';
                    }
                }, 200);
            }, { passive: true });

            btn.addEventListener('click', function(){
                const id = ytExtractId(input.value);
                if (!id) return;
                host.innerHTML = `<iframe width="560" height="315" frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                    referrerpolicy="strict-origin-when-cross-origin" allowfullscreen loading="lazy"
                    src="${ytEmbed(id)}"></iframe>`;
            }, { passive: true });

            const serverValue = input.getAttribute('data-server-value');
            if (serverValue) input.value = embedToShare(serverValue);
            const initId = ytExtractId(input.value);
            if (initId){
                img.src = ytThumb(initId);
                wrap.style.display = 'block';
            }
        };

        window.__ytUtil = { ytExtractId, ytThumb, ytEmbed, embedToShare };
    })();

    // ================= 등록 모달 ================
    const addBoardModal = document.getElementById("addBoardModal");
    const openAddModal = document.getElementById("openAddModal");
    const closeAddBtn = document.querySelector(".closeAddBtn");
    const addBoardForm = document.getElementById("addBoardForm");
    const addImagePreview = document.getElementById("addImagePreview");
    const addImageFile = document.getElementById("addImageFile");

    if(openAddModal) openAddModal.onclick = () => {
        // addBoardModal.style.display = "block";
        addBoardModal.classList.add("show");
        const addVideoField = addBoardModal.querySelector('.video-field');
        bindVideoField(addVideoField);
    };
    if(closeAddBtn) closeAddBtn.onclick = () => addBoardModal.style.display = "none";
    window.addEventListener('click', e => { if(e.target === addBoardModal) addBoardModal.style.display = "none"; });

    addImageFile.addEventListener("change", e => {
        const file = e.target.files[0];
        if(file){
            const reader = new FileReader();
            reader.onload = ev => addImagePreview.innerHTML = `<img src="${ev.target.result}" style="max-width:200px;">`;
            reader.readAsDataURL(file);
        } else {
            addImagePreview.innerHTML = `<p style="margin:0; color:#666;">등록된 이미지가 없습니다.</p>`;
        }
    });

    addBoardForm.addEventListener("submit", async e => {
        e.preventDefault();
        const formData = new FormData(addBoardForm);

        if(!formData.get("boardType")){
            alert("카테고리를 선택해주세요.");
            return;
        }

        try{
            const response = await fetch("/board/create", { method:"POST", body:formData });
            if(response.redirected){
                alert("게시글이 등록되었습니다.");
                addBoardModal.style.display = "none";
                addBoardForm.reset();
                addImagePreview.innerHTML = `<p style="margin:0; color:#666;">등록된 이미지가 없습니다.</p>`;
                window.location.href = "/admin/board";
            } else {
                const text = await response.text();
                alert("등록 실패: " + text);
            }
        }catch(err){ alert("서버 오류: " + err.message); }
    });

    // ================= 카테고리 드롭다운 ================
    const categoryHeader = document.getElementById("categoryHeader");
    const categoryMenu = document.getElementById("categoryMenu");
    const arrow = categoryHeader ? categoryHeader.querySelector(".dropdown-arrow") : null;

    if (categoryHeader) {
        categoryHeader.addEventListener("click", () => {
            categoryMenu.classList.toggle("show");
            if (arrow) arrow.classList.toggle("up");
        });
        window.addEventListener("click", (e) => {
            if (!categoryHeader.contains(e.target)) {
                categoryMenu.classList.remove("show");
                if (arrow) arrow.classList.remove("up");
            }
        });
    }

    // ================= 수정 모달 ================
    const editModal = document.getElementById("editModal");
    const closeEditBtn = document.querySelector(".closeEditBtn");
    const editForm = document.getElementById("editForm");
    const currentImagePreview = document.getElementById("currentImagePreview");

    if(closeEditBtn) closeEditBtn.onclick = () => editModal.classList.remove("show");
    window.addEventListener('click', e => { if(e.target === editModal) editModal.classList.remove("show"); });

    function stripHtmlTags(html) {
        if (!html) return '';
        let content = html;
        content = content.replace(/<img[^>]*src\s*=\s*['"][^'"]*uploads[^'"]*['"][^>]*\/?>/gi, '');
        content = content.replace(/<p[^>]*style[^>]*color:[^>]*>[^<]*<\/p>/gi, '');
        content = content.replace(/(<br\s*\/?>)+/gi, '\n');
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = content;
        return (tempDiv.textContent || tempDiv.innerText || '').trim();
    }

    function editBoard(boardId){
        fetch(`/admin/board/api/${boardId}`)
            .then(res => { if(!res.ok) throw new Error(`HTTP ${res.status}`); return res.json(); })
            .then(board => {
                document.getElementById("editBoardId").value = board.boardId;
                document.getElementById("editTitle").value = board.title || '';
                document.getElementById("editContent").value = stripHtmlTags(board.content);

                const previewDiv = document.getElementById("currentImagePreview");
                if (board.imgUrl && board.imgUrl.trim() !== '') {
                    previewDiv.innerHTML = `
                      <div style="border: 1px solid #ddd; padding: 10px; border-radius: 5px; background-color: #f9f9f9;">
                        <p style="margin: 0 0 10px 0; font-weight: bold; color: #333;">현재 등록된 이미지:</p>
                        <img src="${board.imgUrl}" alt="${board.imgDescription || ''}"
                             style="max-width: 200px; max-height: 150px; object-fit: contain; border: 1px solid #ccc; border-radius: 3px; display: block;">
                        <p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">
                            ${board.imgDescription ? '설명: ' + board.imgDescription : '설명 없음'}
                        </p>
                      </div>`;
                    document.getElementById("editImgDescription").value = board.imgDescription || '';
                } else {
                    previewDiv.innerHTML = `
                      <div>
                        <p style="margin: 0; color: #666">등록된 이미지가 없습니다.</p>
                      </div>`;
                    document.getElementById("editImgDescription").value = '';
                }

                const boardTypeInput = document.querySelector("input[name='boardType']");
                if (boardTypeInput) boardTypeInput.value = board.boardType || '';
                document.getElementById("editImageFile").value = '';

                const videoField = editModal.querySelector('.video-field');
                const videoInput = videoField.querySelector('input[name="videoUrl"]');
                videoInput.setAttribute('data-server-value', board.videoUrl || '');
                bindVideoField(videoField);

                editModal.classList.add("show");
            })
            .catch(e => { alert('게시글 정보를 불러올 수 없습니다: ' + e.message); });
    }

    document.getElementById("editImageFile").addEventListener("change", function(e) {
        const file = e.target.files[0];
        const previewDiv = document.getElementById("currentImagePreview");
        if (file) {
            const reader = new FileReader();
            reader.onload = function(ev) {
                previewDiv.innerHTML = `
                  <div style="border: 1px solid #28a745; padding: 10px; border-radius: 5px; background-color: #d4edda; color: #155724;">
                    <p style="margin: 0 0 10px 0; font-weight: bold;">새로 선택된 이미지:</p>
                    <img src="${ev.target.result}" alt="새 이미지 미리보기"
                         style="max-width: 200px; max-height: 150px; object-fit: contain; border: 1px solid #ccc; border-radius: 3px; display: block;">
                    <p style="margin: 5px 0 0 0; font-size: 12px;">파일명: ${file.name}</p>
                  </div>`;
            };
            reader.readAsDataURL(file);
        }
    });

    if (editForm) {
        editForm.addEventListener("submit", async e => {
            e.preventDefault();
            const formData = new FormData();
            formData.append('id', document.getElementById("editBoardId").value);
            formData.append('title', document.getElementById("editTitle").value);
            formData.append('content', document.getElementById("editContent").value);
            formData.append('page', document.querySelector("input[name='page']").value || '0');
            formData.append('boardType', document.querySelector("input[name='boardType']").value || '전체');

            const imageFile = document.getElementById("editImageFile").files[0];
            if (imageFile) formData.append('imageFile', imageFile);

            const imgDescription = document.getElementById("editImgDescription").value;
            if (imgDescription) formData.append('imgDescription', imgDescription);

            const videoUrl = editForm.querySelector('.video-field input[name="videoUrl"]').value || '';
            formData.append('videoUrl', videoUrl);

            try {
                const response = await fetch("/admin/board/edit", { method: "POST", body: formData });
                if (response.ok) {
                    editModal.classList.remove("show");
                    alert('게시글이 수정되었습니다.');
                    window.location.href = `/admin/board`;
                } else {
                    alert("수정에 실패했습니다: " + await response.text());
                }
            } catch (error) {
                alert("수정 중 오류가 발생했습니다: " + error.message);
            }
        });
    }

    // ================= 상세보기 모달 ================
    const viewModal = document.getElementById("viewModal");
    const closeViewBtn = document.querySelector(".closeViewBtn");
    let currentBoardData = null;

    function viewBoard(boardId) {
        fetch(`/admin/board/api/${boardId}`)
            .then(r => { if(!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); })
            .then(board => {
                currentBoardData = board;
                document.getElementById("viewTitle").textContent = board.title || '';

                const viewContentDiv = document.getElementById("viewContent");
                viewContentDiv.innerHTML = board.content ? board.content : '내용이 없습니다.';

                if (board.videoUrl) {
                    const videoHtml = `
                      <div style="margin-top:16px;">
                        <iframe src="${board.videoUrl}" width="560" height="315" frameborder="0"
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                                referrerpolicy="strict-origin-when-cross-origin" allowfullscreen loading="lazy"></iframe>
                      </div>`;
                    viewContentDiv.insertAdjacentHTML('beforeend', videoHtml);
                }

                viewModal.classList.add("show");
            })
            .catch(e => { alert('게시글 정보를 불러올 수 없습니다: ' + e.message); });
    }

    function closeViewModal() {
        viewModal.classList.remove("show");
        currentBoardData = null;
    }

    if (closeViewBtn) closeViewBtn.onclick = closeViewModal;
    window.addEventListener('click', (e) => { if (e.target === viewModal) closeViewModal(); });

    // ================= 삭제 ================
    async function deleteBoard(boardId) {
        if (!confirm(`${boardId}번 게시물을 삭제하시겠습니까?`)) return;
        try {
            const response = await fetch(`/admin/board/delete/${boardId}`, { method: 'DELETE' });
            if (response.ok) {
                alert('게시글이 삭제되었습니다.');
                location.reload();
            } else {
                alert('삭제에 실패했습니다: ' + await response.text());
            }
        } catch (error) {
            alert('삭제 중 오류가 발생했습니다.');
        }
    }

    // 전역 함수 노출
    window.deleteBoard = deleteBoard;
    window.viewBoard = viewBoard;
    window.editBoard = editBoard;
    window.closeViewModal = closeViewModal;
</script>
</body>
</html>