<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>댓글 관리</title>
    <link rel="stylesheet" th:href="@{/css/adminComment.css}">
</head>

<body>
<header>
    <a th:href="@{/}">
        <img th:src="@{/img/mainLg2.png}" alt="메인 로고">
    </a>
    <ul>
        <li><a th:href="@{/board/topic}">학습하기</a></li>
        <li><a th:href="@{/quiz/topic}">퀴즈풀기</a></li>
        <li><a th:href="@{/attend}">출석하기</a></li>
        <li><a th:href="@{/pointStore}">포인트 상점</a></li>
        <li><a th:href="@{/faq}">FAQ</a></li>
        <li><a th:href="@{/notice}">공지사항</a></li>
    </ul>
    <div id="user" th:if="${session.loginUser != null}">
        <a th:if="${session.loginUser.userType == '관리자'}"
           th:href="@{/admin/users}"
           th:text="${session.loginUser.name} + '님'"></a>
    </div>
    <script th:if="${session.loginUser == null}" th:inline="javascript">
        window.location.href = '/';
    </script>
</header>

<div id="sidebar">
    <ul>
        <li><a th:href="@{/admin/users}">회원관리</a></li>
        <li class="submenuBox">
            <a th:href="@{/admin/board}">게시글관리</a>
            <ul class="submenu">
                <li><a th:href="@{/admin/board}">학습하기</a></li>
                <li><a th:href="@{/admin/quiz}">퀴즈풀기</a></li>
                <li><a th:href="@{/admin/notice}">공지사항</a></li>
            </ul>
        </li>
        <li><a th:href="@{/admin/comment}" class="active">댓글관리</a></li>
        <li><a th:href="@{/admin/pointStore}">상점관리</a></li>
    </ul>
</div>

<div id="container">
    <!-- 성공/에러 메시지 -->
    <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
    <div th:if="${errorMessage}" class="alert alert-error" th:text="${errorMessage}"></div>

    <div class="cmt-box">
        <div class="cmt-title-box">
            <div class="cmt-title">댓글관리</div>
        </div>

        <table class="cmt-table">
            <thead>
            <tr>
                <th style="width: 190px;">
                    <div id="categoryHeader">
                        카테고리
                        <span class="dropdown-arrow">▼</span>
                        <ul id="categoryTableMenu">
                            <li><a th:href="@{/admin/comment(category='전체', page=1)}" data-category="전체">전체</a></li>
                            <li><a th:href="@{/admin/comment(category='선사시대', page=1)}" data-category="선사시대">선사시대</a></li>
                            <li><a th:href="@{/admin/comment(category='고조선과 여러 나라', page=1)}" data-category="고조선과 여러 나라">고조선과 여러 나라</a></li>
                            <li><a th:href="@{/admin/comment(category='삼국과 가야', page=1)}" data-category="삼국과 가야">삼국과 가야</a></li>
                            <li><a th:href="@{/admin/comment(category='남북극시대', page=1)}" data-category="남북극시대">남북극시대</a></li>
                            <li><a th:href="@{/admin/comment(category='고려시대', page=1)}" data-category="고려시대">고려시대</a></li>
                            <li><a th:href="@{/admin/comment(category='조선시대', page=1)}" data-category="조선시대">조선시대</a></li>
                            <li><a th:href="@{/admin/comment(category='근대', page=1)}" data-category="근대">근대</a></li>
                            <li><a th:href="@{/admin/comment(category='현대', page=1)}" data-category="현대">현대</a></li>
                            <li><a th:href="@{/admin/comment(category='공지사항', page=1)}" data-category="공지사항">공지사항</a></li>
                        </ul>
                    </div>
                </th>
                <th>내용</th>
                <th style="width: 140px;">작성자</th>
                <th style="width: 120px;">작성일자</th>
                <th style="width: 140px;">작업</th>
            </tr>
            </thead>
            <tbody id="cmt-body">
            <!-- 댓글 목록 -->
            <th:block th:each="comment, iterStat : ${comments}" th:if="${not #lists.isEmpty(comments)}">
                <tr class="comment-row">
                    <td th:text="${boardTypeMap[comment.boardId]}">카테고리</td>
                    <td class="content-cell">
                        <!-- 클릭 가능한 내용 영역 -->
                        <div class="clickable-content" th:onclick="'location.href=\'/board/detail?boardId=' + ${comment.boardId} + '\''">
                            <div class="post-title">
                                <span th:text="'[' + ${boardTitleMap[comment.boardId]} + ']'">[게시글 제목]</span>
                            </div>
                            <div class="comment-text" th:text="${comment.comment}">댓글 내용</div>
                        </div>
                    </td>
                    <td th:text="${comment.name}">작성자</td>
                    <td th:text="${#temporals.format(comment.date, 'yyyy-MM-dd')}">2025-09-20</td>
                    <td>
                        <!-- 댓글 삭제 -->
                        <form th:action="@{/admin/comment/delete/{commentId}(commentId=${comment.commentId})}"
                              method="post"
                              onsubmit="return confirm('댓글과 관련된 모든 답글이 삭제됩니다. 정말로 삭제하시겠습니까?');">
                            <input type="hidden" name="category" th:value="${selectedCategory}">
                            <input type="hidden" name="page" th:value="${currentPage}">
                            <button type="submit" class="delete-btn">삭제</button>
                        </form>
                    </td>
                </tr>

                <!-- 답글 목록 -->
                <th:block th:if="${repliesMap[comment.commentId] != null and not #lists.isEmpty(repliesMap[comment.commentId])}">
                    <tr th:each="reply : ${repliesMap[comment.commentId]}" class="reply-row">
                        <td th:text="${boardTypeMap[comment.boardId]}">카테고리</td>
                        <td class="content-cell">
                            <!-- 답글은 게시물 링크 포함 -->
                            <div class="clickable-content" th:onclick="'location.href=\'/board/detail?boardId=' + ${comment.boardId} + '\''">
                                <div class="post-title">
                                    <span th:text="'[' + ${boardTitleMap[comment.boardId]} + ']'">[게시글 제목]</span>
                                </div>
                                <div class="comment-text reply-text" th:text="'↳ ' + ${reply.reply}">↳ 답글 내용</div>
                            </div>
                        </td>
                        <td th:text="${reply.name}">답글작성자</td>
                        <td th:text="${#temporals.format(reply.date, 'yyyy-MM-dd')}">2025-09-20</td>
                        <td>
                            <!-- 답글 삭제 -->
                            <form th:action="@{/admin/reply/delete/{replyId}(replyId=${reply.replyId})}"
                                  method="post"
                                  style="display: inline;"
                                  onsubmit="return confirm('정말로 답글을 삭제하시겠습니까?');"
                                  onclick="event.stopPropagation();">
                                <input type="hidden" name="category" th:value="${selectedCategory}">
                                <input type="hidden" name="page" th:value="${currentPage}">
                                <button type="submit" class="delete-btn reply-delete">삭제</button>
                            </form>
                        </td>
                    </tr>
                </th:block>
            </th:block>

            <!-- 댓글이 없을 경우 -->
            <tr th:if="${#lists.isEmpty(comments)}">
                <td colspan="5" style="text-align: center; padding: 40px; color: #666;">
                    <div>댓글이 없습니다.</div>
                </td>
            </tr>
            </tbody>
        </table>

        <!-- 페이징 영역 -->
        <div id="cmt-pagination" class="cmt-pagination" th:if="${totalPages >= 1 and not #lists.isEmpty(comments)}">
            <button th:if="${currentPage > 1}"
                    th:data-category="${selectedCategory}"
                    th:data-page="${currentPage - 1}"
                    class="page-nav-btn"
                    type="button">◀</button>
            <button th:if="${currentPage == 1}" type="button" disabled>◀</button>

            <th:block th:each="pageNum : ${#numbers.sequence(1, totalPages)}">
                <button th:text="${pageNum}"
                        th:classappend="${pageNum == currentPage} ? 'active' : ''"
                        th:data-category="${selectedCategory}"
                        th:data-page="${pageNum}"
                        class="page-nav-btn"
                        type="button">1</button>
            </th:block>

            <button th:if="${currentPage < totalPages}"
                    th:data-category="${selectedCategory}"
                    th:data-page="${currentPage + 1}"
                    class="page-nav-btn"
                    type="button">▶</button>
            <button th:if="${currentPage == totalPages}" type="button" disabled>▶</button>
        </div>
    </div>
</div>

<div id="footer">
    <ul>
        <li>대표전화: 042-222-2402</li>
        <li>주소: (34838) 대전 중구 중앙로121번길 20(방산빌딩 3층)</li>
        <li>운영시간: 평일 09:00 ~ 18:00 (주말·공휴일 휴무)</li>
        <li>© 2025 역사 한 걸음. All rights reserved.</li>
    </ul>
</div>

<script th:src="@{/js/adminComment.js}"></script>

<script>
    // 삭제 버튼 클릭 시 이벤트 전파 방지
    document.addEventListener('DOMContentLoaded', function() {
        const deleteForms = document.querySelectorAll('form[action*="/delete/"]');
        deleteForms.forEach(form => {
            form.addEventListener('click', function(e) {
                e.stopPropagation();
            });

            const deleteBtn = form.querySelector('button[type="submit"]');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            }
        });

        // 페이지네이션 버튼 클릭 처리
        const pageButtons = document.querySelectorAll('.page-nav-btn:not([disabled])');
        pageButtons.forEach(button => {
            button.addEventListener('click', function() {
                const category = this.dataset.category;
                const page = this.dataset.page;
                window.location.href = `/admin/comment?category=${encodeURIComponent(category)}&page=${page}`;
            });
        });

        // 카테고리 드롭다운 처리
        const categoryHeader = document.getElementById('categoryHeader');
        const categoryMenu = document.getElementById('categoryTableMenu');

        if (categoryHeader && categoryMenu) {
            categoryHeader.addEventListener('click', function(e) {
                e.stopPropagation();
                categoryMenu.style.display = categoryMenu.style.display === 'block' ? 'none' : 'block';
            });

            // 외부 클릭 시 드롭다운 닫기
            document.addEventListener('click', function(e) {
                if (!categoryHeader.contains(e.target)) {
                    categoryMenu.style.display = 'none';
                }
            });
        }
    });
</script>

</body>
</html>