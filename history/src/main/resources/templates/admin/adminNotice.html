<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>공지사항 관리</title>
    <link rel="stylesheet" th:href="@{/css/adminBoardList.css}">
</head>

<body>
<header>
    <a th:href="@{/}">
        <img th:src="@{/img/mainLg2.png}" alt="메인 로고">
    </a>
    <ul>
        <li><a th:href="@{/board/topic}">학습하기</a></li>
        <li><a th:href="@{/quiz/topic}">퀴즈풀기</a></li>
        <li><a th:href="@{/attend}">출석하기</a></li>
        <li><a th:href="@{/pointStore}">포인트 상점</a></li>
        <li><a th:href="@{/faq}">FAQ</a></li>
        <li><a th:href="@{/notice}">공지사항</a></li>
    </ul>

    <div id="user" th:if="${session.loginUser != null}">
        <a th:if="${session.loginUser.userType == '관리자'}"
           th:href="@{/admin/users}"
           th:text="${session.loginUser.name} + '님'"></a>
    </div>

    <script th:if="${session.loginUser == null}" th:inline="javascript">
        window.location.href = '/';
    </script>
</header>

<div id="sidebar">
    <ul>
        <li><a th:href="@{/admin/users}">회원관리</a></li>
        <li class="submenuBox">
            <a th:href="@{/admin/board}" class="active">게시글관리</a>
            <ul class="submenu">
                <li><a th:href="@{/admin/board}">학습하기</a></li>
                <li><a th:href="@{/admin/quiz}">퀴즈풀기</a></li>
                <li><a th:href="@{/admin/notice}" class="active">공지사항</a></li>
            </ul>
        </li>
        <li><a th:href="@{/admin/comment}">댓글관리</a></li>
        <li><a th:href="@{/admin/pointStore}">상점관리</a></li>
    </ul>
</div>

<div id="container">
    <div class="boardBox">
        <div id="notice-title-box">
            <div class="board-title">공지사항</div>
            <button class="add-notice-btn">공지사항 등록</button>
        </div>

        <!-- URL 파라미터 메시지 표시 -->
        <div th:if="${param.success}" class="alert success" th:text="${param.success[0]}"></div>
        <div th:if="${param.error}" class="alert error" th:text="'오류: ' + ${param.error[0]}"></div>

        <!-- 게시물 관리 테이블 -->
        <table class="board-table">
            <thead>
            <tr>
                <th style="width: 100px;">번호</th>
                <th>제목</th>
                <th style="width: 150px;">등록 일자</th>
                <th style="width: 80px;">작업</th>
            </tr>
            </thead>

            <tbody id="board-body">
            <tr th:each="board, stat : ${boards}">
                <td th:text="${(currentPage != null ? currentPage : 0) * 10 + stat.count}">1</td>
                <td>
                    <span class="board-link" th:text="${board.title}"
                          th:onclick="'viewNotice(' + ${board.boardId} + ')'"
                          style="cursor: pointer; color: #007bff; text-decoration: underline;">공지사항 제목</span>
                </td>
                <td th:text="${#dates.format(board.created, 'yyyy-MM-dd')}">2025-01-01</td>
                <td>
                    <button th:onclick="'editNotice(' + ${board.boardId} + ')'" class="editBtn">수정</button>
                    <button th:onclick="'deleteNotice(' + ${board.boardId} + ')'" class="deleteBtn">삭제</button>
                </td>
            </tr>

            <!-- 부족한 만큼 빈 행 추가 -->
            <th:block th:if="${boards != null and #lists.size(boards) < 10}">
                <tr th:each="i : ${#numbers.sequence(1, 10 - #lists.size(boards))}">
                    <td>&nbsp;</td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
            </th:block>

            <!-- 게시글이 아예 없는 경우 -->
            <tr th:if="${boards == null or #lists.isEmpty(boards)}">
                <td colspan="4" style="text-align: center; padding: 50px;">등록된 공지사항이 없습니다.</td>
            </tr>
            </tbody>

        </table>

        <!-- ========== 공지사항 등록 모달 (제목/내용만) ========== -->
        <div id="addModal" class="modal">
            <div class="modal-content">
                <span class="closeAddBtn">&times;</span>
                <h2>공지사항 등록</h2>
                <form id="addForm" action="/board/create" method="post">
                    <input type="hidden" name="boardType" value="공지사항">

                    <label></label>
                    <input type="text" name="title" placeholder="제목" required>

                    <label></label>
                    <textarea name="content" placeholder="내용" required></textarea>

                    <button type="submit">등록하기</button>
                </form>
            </div>
        </div>

        <!-- ========== 수정 모달 ========== -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <span class="closeBtn">&times;</span>
                <h2>공지사항 수정</h2>
                <form id="editForm" th:action="@{/admin/notice/edit}" method="post">
                    <input type="hidden" id="editNoticeId" name="id" />
                    <input type="hidden" name="page" th:value="${currentPage}" />
                    <input type="text" id="editTitle" name="title" placeholder="제목" required>
                    <textarea id="editContent" name="content" placeholder="내용" required></textarea>
                    <button type="submit" id="editBoard-btn">수정 완료</button>
                </form>
            </div>
        </div>

        <!-- ========== 상세보기 모달 ========== -->
        <div id="viewModal" class="modal">
            <div class="modal-content">
                <span class="closeViewBtn">&times;</span>
                <h2>공지사항 상세보기</h2>
                <div class="view-form">
                    <div class="form-group">
                        <label>제목:</label>
                        <div id="viewTitle" class="view-field"></div>
                    </div>
                    <div class="form-group">
                        <label>내용:</label>
                        <div id="viewContent" class="view-content"></div>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button type="button" onclick="closeViewModal()">닫기</button>
                </div>
            </div>
        </div>

        <!-- Thymeleaf 페이징 -->
        <div id="pagination" class="pagination" th:if="${totalPages > 0}">
            <a th:if="${currentPage > 0}" th:href="@{/admin/notice(page=${currentPage - 1})}" class="page-btn">◀</a>
            <span th:unless="${currentPage > 0}" class="page-btn disabled">◀</span>

            <th:block th:each="i : ${#numbers.sequence(0, totalPages - 1)}">
                <a th:unless="${i == currentPage}" th:href="@{/admin/notice(page=${i})}" th:text="${i + 1}" class="page-btn"></a>
                <span th:if="${i == currentPage}" th:text="${i + 1}" class="page-btn active"></span>
            </th:block>

            <a th:if="${currentPage < totalPages - 1}" th:href="@{/admin/notice(page=${currentPage + 1})}" class="page-btn">▶</a>
            <span th:unless="${currentPage < totalPages - 1}" class="page-btn disabled">▶</span>
        </div>
    </div>
</div>

<div id="footer">
    <ul>
        <li>대표전화: 042-222-2402</li>
        <li>주소: (34838) 대전 중구 중앙로121번길 20(방산빌딩 3층)</li>
        <li>운영시간: 평일 09:00 ~ 18:00 (주말·공휴일 휴무)</li>
        <li>© 2025 역사 한 걸음. All rights reserved.</li>
    </ul>
</div>

<script>
    // ================= 삭제 =================
    async function deleteNotice(noticeId) {
        if (!confirm(`공지사항을 삭제하시겠습니까?`)) return;
        try {
            const response = await fetch(`/admin/notice/delete/${noticeId}`, { method: 'DELETE' });
            if (response.ok) {
                alert('공지사항이 삭제되었습니다.');
                location.reload();
            } else {
                const errorText = await response.text();
                alert('삭제에 실패했습니다: ' + errorText);
            }
        } catch (error) {
            alert('삭제 중 오류가 발생했습니다.');
        }
    }

    // ================= 등록 모달 =================
    const addModal = document.getElementById("addModal");
    const addBtn = document.querySelector(".add-notice-btn");
    const closeAddBtn = document.querySelector(".closeAddBtn");

    addBtn.addEventListener("click", () => addModal.classList.add("show"));
    closeAddBtn.addEventListener("click", () => addModal.classList.remove("show"));
    window.addEventListener("click", e => { if (e.target === addModal) addModal.classList.remove("show"); });

    const addForm = document.getElementById("addForm");
    if (addForm) {
        addForm.addEventListener("submit", async e => {
            e.preventDefault();
            const formData = new FormData(addForm);
            try {
                const response = await fetch("/board/create", { method: "POST", body: formData });
                if (response.ok) {
                    addModal.classList.remove("show");
                    alert("공지사항이 등록되었습니다.");
                    window.location.reload();
                } else {
                    const errorText = await response.text();
                    alert("등록 실패: " + errorText);
                }
            } catch (error) {
                alert("등록 중 오류가 발생했습니다: " + error.message);
                console.error(error);
            }
        });
    }

    // ================= 수정 모달 =================
    const modal = document.getElementById("editModal");
    const closeBtn = document.querySelector(".closeBtn");
    function stripHtmlTags(html) {
        if (!html) return '';
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        const images = tempDiv.querySelectorAll('img');
        images.forEach(img => img.remove());
        return tempDiv.textContent || tempDiv.innerText || '';
    }
    function editNotice(noticeId) {
        fetch(`/admin/notice/api/${noticeId}`)
            .then(res => res.ok ? res.json() : Promise.reject(res.status))
            .then(notice => {
                document.getElementById("editNoticeId").value = notice.boardId;
                document.getElementById("editTitle").value = notice.title || '';
                document.getElementById("editContent").value = stripHtmlTags(notice.content);
                modal.classList.add("show");
            })
            .catch(err => alert('공지사항 정보를 불러올 수 없습니다: ' + err));
    }
    if (closeBtn) closeBtn.onclick = () => modal.classList.remove("show");
    window.onclick = e => { if (e.target == modal) modal.classList.remove("show"); };

    const editForm = document.getElementById("editForm");
    if (editForm) {
        editForm.addEventListener("submit", async e => {
            e.preventDefault();
            const formData = new FormData(editForm);
            try {
                const response = await fetch("/admin/notice/edit", { method: "POST", body: formData });
                if (response.ok) {
                    modal.classList.remove("show");
                    alert('공지사항이 수정되었습니다.');
                    window.location.href = `/admin/notice`;
                } else {
                    const errorText = await response.text();
                    alert("수정에 실패했습니다: " + errorText);
                }
            } catch (error) {
                alert("수정 중 오류가 발생했습니다: " + error.message);
            }
        });
    }

    // ================= 상세보기 모달 =================
    const viewModal = document.getElementById("viewModal");
    const closeViewBtn = document.querySelector(".closeViewBtn");
    let currentNoticeData = null;

    function viewNotice(noticeId) {
        fetch(`/admin/notice/api/${noticeId}`)
            .then(res => res.ok ? res.json() : Promise.reject(res.status))
            .then(notice => {
                currentNoticeData = notice;
                document.getElementById("viewTitle").textContent = notice.title || '';
                document.getElementById("viewContent").innerHTML = notice.content || '내용이 없습니다.';
                viewModal.classList.add("show");
            })
            .catch(err => alert('공지사항 정보를 불러올 수 없습니다: ' + err));
    }

    function closeViewModal() {
        viewModal.classList.remove("show");
        currentNoticeData = null;
    }

    if (closeViewBtn) closeViewBtn.onclick = closeViewModal;
    window.addEventListener('click', e => { if (e.target === viewModal) closeViewModal(); });
</script>
</body>
</html>