<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íšŒì› ëª©ë¡ ê´€ë¦¬</title>
    <link rel="stylesheet" href="/css/adminPage.css">
</head>
<body>
<header>
    <a href="/home">
        <img src="/img/mainLg2.png" alt="ë©”ì¸ ë¡œê³ ">
    </a>
    <ul>
        <li><a href="">í•™ìŠµí•˜ê¸°</a></li>
        <li><a href="">í€´ì¦ˆí’€ê¸°</a></li>
        <li><a href="/attend">ì¶œì„í•˜ê¸°</a></li>
        <li><a href="">í¬ì¸íŠ¸ ìƒì </a></li>
        <li><a href="/faq">FAQ</a></li>
        <li><a href="/notice">ê³µì§€ì‚¬í•­</a></li>
    </ul>
    <div id="user" style="display: none;">
        <a href="/myPage" id="userName-link" class="active"> ë‹˜</a>
    </div>
</header>

<div id="sideber">
    <ul>
        <li><a href="/admin/users" class="active">íšŒì›ê´€ë¦¬</a></li>
        <li><a href="">ê²Œì‹œê¸€ê´€ë¦¬</a></li>
        <li><a href="">ëŒ“ê¸€ê´€ë¦¬</a></li>
        <li><a href="">ìƒì ê´€ë¦¬</a></li>
    </ul>
</div>

<div id="container">
    <div class="userlistBox">
        <div class="userlist-title">íšŒì›ê´€ë¦¬</div>
        <div class="userlist-addUserBtn">
            <a href="javascript:void(0)" id="addUserBtn">íšŒì›ë“±ë¡</a>
        </div>

        <!-- íšŒì› ë“±ë¡ íŒì—… -->
        <div id="addUserBox" class="modal" style="display: none;">
            <div class="modal-content">
                <span id="closeModal" style="float:right; cursor:pointer;">&times;</span>
                <h2>íšŒì› ë“±ë¡</h2>
                <form id="addUserForm">
                    <label>ID</label>
                    <div class="emailBox">
                        <input type="email" id="emailInput" name="email" required placeholder="abc123@gmail.com">
                        <button type="button" id="checkEmailBtn">ì¤‘ë³µí™•ì¸</button>
                    </div>
                    <small id="emailMessage" style="color:red; display:none;"></small><br>

                    <label>PASSWORD</label>
                    <div class="passwordBox">
                        <input type="password" name="password" required placeholder="*******">
                    </div>
                    <label>NAME</label>
                    <div class="emailBox">
                        <input type="text" name="name" required placeholder="í™ê¸¸ë™">
                    </div>
                    <div class="addBtn">
                        <button type="submit">ë“±ë¡</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- íšŒì› ëª©ë¡ í…Œì´ë¸” -->
        <table class="userlist-table">
            <thead>
            <tr>
                <th>ë²ˆí˜¸</th>
                <th>ì´ë¦„</th>
                <th>ì´ë©”ì¼</th>
                <th>ìœ ì € íƒ€ì…</th>
                <th>ì¶œì„ í˜„í™©</th>
                <th>í¬ì¸íŠ¸</th>
                <th>ì‘ì—…</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="user, iterStat : ${users}">
                <td th:text="${iterStat.count}"></td>
                <td th:text="${user.name}"></td>
                <td th:text="${user.email}"></td>
                <td th:text="${user.userType}"></td>
                <td th:text="${user.attend == true || user.attend == 'Y' ? 'ì¶œì„' : 'ë¯¸ì¶œì„'}"></td>
                <td th:text="${user.point}"></td>
                <td>
                    <a th:if="${user.userType != 'ê´€ë¦¬ì'}"
                       th:href="@{|/admin/users/delete?email=${user.email}|}"
                       class="delete-button"
                       onclick="return confirm('ì •ë§ë¡œ ì´ íšŒì›ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">ì‚­ì œ</a>
                </td>
            </tr>
            </tbody>
        </table>

        <!-- í˜ì´ì§• -->
        <div class="pagination">
            <a th:if="${currentPage > 1}" th:href="@{|/admin/users?page=${currentPage - 1}|}">â—€ ì´ì „</a>
            <span th:each="i : ${#numbers.sequence(1, totalPages)}">
                <a th:if="${i != currentPage}" th:href="@{|/admin/users?page=${i}|}" th:text="${i}"></a>
                <span th:if="${i == currentPage}" class="current-page" th:text="${i}"></span>
            </span>
            <a th:if="${currentPage < totalPages}" th:href="@{|/admin/users?page=${currentPage + 1}|}">ë‹¤ìŒ â–¶</a>
        </div>

    </div>
</div>

<div id="footer">
    <ul>
        <li>ëŒ€í‘œì „í™”: 042-222-2402</li>
        <li>ì£¼ì†Œ: (34838) ëŒ€ì „ ì¤‘êµ¬ ì¤‘ì•™ë¡œ121ë²ˆê¸¸ 20(ë°©ì‚°ë¹Œë”© 3ì¸µ)</li>
        <li>ìš´ì˜ì‹œê°„: í‰ì¼ 09:00 ~ 18:00 (ì£¼ë§Â·ê³µíœ´ì¼ íœ´ë¬´)</li>
        <li>Â© 2025 ì—­ì‚¬ í•œ ê±¸ìŒ. All rights reserved.</li>
    </ul>
</div>

<!-- ìŠ¤í¬ë¦½íŠ¸ -->
<script>
    // ë¡œê·¸ì¸ ì²´í¬
    async function checkLogin() {
        try {
            const response = await fetch("/api/check-login", {
                credentials: "include"
            });
            const data = await response.json();
            const userDiv = document.getElementById("user");
            const usernameLink = document.getElementById("userName-link");

            if (data.isLoggedIn) {
                if (data.role === "admin") {
                    usernameLink.textContent = data.username + " ê´€ë¦¬ì";
                    usernameLink.href = "/admin/dashboard.html";
                } else {
                    usernameLink.textContent = data.username;
                    usernameLink.href = "/mypage/mypage.html";
                }
                userDiv.style.display = "block";
            } else {
                userDiv.style.display = "none";
            }
        } catch (err) {
            console.error("ë¡œê·¸ì¸ ì²´í¬ ì—ëŸ¬:", err);
        }
    }

    window.onload = checkLogin;

    // íšŒì› ë“±ë¡ íŒì—… ê´€ë ¨
    const addUserBtn = document.getElementById("addUserBtn");
    const modal = document.getElementById("addUserBox");
    const closeModal = document.getElementById("closeModal");
    const addUserForm = document.getElementById("addUserForm");
    const emailInput = document.getElementById("emailInput");
    const checkEmailBtn = document.getElementById("checkEmailBtn");
    const emailMessage = document.getElementById("emailMessage");

    let emailValid = false;

    addUserBtn.addEventListener("click", () => {
        modal.style.display = "flex";
    });

    closeModal.addEventListener("click", () => {
        modal.style.display = "none";
        addUserForm.reset();
        emailMessage.style.display = "none";
        emailValid = false;
    });

    window.addEventListener("click", (e) => {
        if (e.target === modal) modal.style.display = "none";
    });

    // ğŸš© ìˆ˜ì •ëœ ì´ë©”ì¼ ì¤‘ë³µ í™•ì¸ ìŠ¤í¬ë¦½íŠ¸
    checkEmailBtn.addEventListener("click", async () => {
        const email = emailInput.value.trim();
        if (!email) {
            emailMessage.textContent = "ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.";
            emailMessage.style.color = "red";
            emailMessage.style.display = "block";
            emailValid = false;
            return;
        }

        try {
            // ğŸš© ìˆ˜ì •: API URLì„ '/api/admin/users/check-email'ë¡œ ë³€ê²½
            const response = await fetch(`/api/admin/users/check-email?email=${encodeURIComponent(email)}`);
            const data = await response.json();

            if (data.exists) {
                emailMessage.textContent = "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.";
                emailMessage.style.color = "red";
                emailValid = false;
            } else {
                emailMessage.textContent = "ì‚¬ìš© ê°€ëŠ¥í•œ ì´ë©”ì¼ì…ë‹ˆë‹¤.";
                emailMessage.style.color = "green";
                emailValid = true;
            }
            emailMessage.style.display = "block";
        } catch (err) {
            emailMessage.textContent = "ì¤‘ë³µ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
            emailMessage.style.color = "red";
            emailMessage.style.display = "block";
            emailValid = false;
        }
    });

    // ğŸš© ìˆ˜ì •ëœ íšŒì› ë“±ë¡ ìŠ¤í¬ë¦½íŠ¸
    addUserForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!emailValid) {
            alert("ì´ë©”ì¼ ì¤‘ë³µí™•ì¸ì„ í•´ì£¼ì„¸ìš”.");
            return;
        }

        const formData = new FormData(addUserForm);
        const userData = {
            name: formData.get("name"),
            email: formData.get("email"),
            password: formData.get("password")
        };

        try {
            // ğŸš© ìˆ˜ì •: API URLì„ '/api/admin/users/register'ë¡œ ë³€ê²½
            const response = await fetch("/api/admin/users/register", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(userData)
            });

            if (response.ok) {
                alert("íšŒì›ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
                modal.style.display = "none";
                addUserForm.reset();
                emailMessage.style.display = "none";
                emailValid = false;
                window.location.reload(); // ì„œë²„ ë Œë”ë§ ë°©ì‹ì´ë¼ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
            } else {
                const errorData = await response.json();
                alert("íšŒì› ë“±ë¡ ì‹¤íŒ¨: " + errorData.message);
            }
        } catch (err) {
            console.error(err);
            alert("ì„œë²„ ì˜¤ë¥˜");
        }
    });
</script>
</body>
</html>
