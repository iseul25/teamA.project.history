<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${board.title}">학습 게시물</title>
    <link rel="stylesheet" th:href="@{/css/detailBoard.css}">
    <!-- (선택) 유튜브/썸네일 프리커넥트 -->
    <link rel="preconnect" href="https://www.youtube.com">
    <link rel="preconnect" href="https://img.youtube.com">
    <style>
        /* 학습완료 버튼 스타일 */
        .done-btn-box {
            text-align: center;
            margin: 30px 0;
        }

        #done-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #done-btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }

        #done-btn:hover:not(:disabled) {
            background-color: #218838;
            transform: translateY(-1px);
        }

        .timer-info {
            color: #666;
            font-size: 14px;
            margin-top: 10px;
        }
    </style>
</head>

<body>
<header>
    <a th:href="@{/}">
        <img th:src="@{/img/mainLg2.png}" alt="메인 로고">
    </a>
    <ul>
        <li><a th:href="@{/board/topic}" class="active">학습하기</a></li>
        <li><a th:href="@{/quiz/topic}">퀴즈풀기</a></li>
        <li><a th:href="@{/attend}">출석하기</a></li>
        <li><a th:href="@{/pointStore}">포인트 상점</a></li>
        <li><a th:href="@{/faq}">FAQ</a></li>
        <li><a th:href="@{/notice}">공지사항</a></li>
    </ul>
    <div id="user" th:if="${session.loginUser != null}">
        <!-- 관리자인 경우 -->
        <a th:if="${session.loginUser.userType == '관리자'}"
           th:href="@{/admin/users}"
           class="userName-link"
           th:text="${session.loginUser.name} + '님'"></a>

        <!-- 일반 사용자인 경우 -->
        <a th:unless="${session.loginUser.userType == '관리자'}"
           th:href="@{/user/myPage}"
           class="userName-link"
           th:text="${session.loginUser.name} + '님'"></a>
    </div>
</header>

<div id="sidebar">
    <div class="sideBox">
        <ul>
            <li class="submenuBox">
                <span class="mainMenu">선사시대 <span class="arrow">&#9660;</span></span>
                <ul class="submenu">
                    <li><a th:href="@{/board/list(boardType='선사시대')}" class="study-link">학습하기</a></li>
                    <li><a th:href="@{/quiz/list(quizType='선사시대')}" class="quiz-link">퀴즈풀기</a></li>
                </ul>
            </li>

            <li class="submenuBox">
                <span class="mainMenu">고조선과 여러 나라 <span class="arrow">&#9660;</span></span>
                <ul class="submenu">
                    <li><a th:href="@{/board/list(boardType='고조선과 여러 나라')}" class="study-link">학습하기</a></li>
                    <li><a th:href="@{/quiz/list(quizType='고조선과 여러 나라')}" class="quiz-link">퀴즈풀기</a></li>
                </ul>
            </li>

            <li class="submenuBox">
                <span class="mainMenu">삼국과 가야 <span class="arrow">&#9660;</span></span>
                <ul class="submenu">
                    <li><a th:href="@{/board/list(boardType='삼국과 가야')}" class="study-link">학습하기</a></li>
                    <li><a th:href="@{/quiz/list(quizType='삼국과 가야')}" class="quiz-link">퀴즈풀기</a></li>
                </ul>
            </li>

            <li class="submenuBox">
                <span class="mainMenu">남북극시대 <span class="arrow">&#9660;</span></span>
                <ul class="submenu">
                    <li><a th:href="@{/board/list(boardType='남북극시대')}" class="study-link">학습하기</a></li>
                    <li><a th:href="@{/quiz/list(quizType='남북극시대')}" class="quiz-link">퀴즈풀기</a></li>
                </ul>
            </li>

            <li class="submenuBox">
                <span class="mainMenu">고려시대 <span class="arrow">&#9660;</span></span>
                <ul class="submenu">
                    <li><a th:href="@{/board/list(boardType='고려시대')}" class="study-link">학습하기</a></li>
                    <li><a th:href="@{/quiz/list(quizType='고려시대')}" class="quiz-link">퀴즈풀기</a></li>
                </ul>
            </li>

            <li class="submenuBox">
                <span class="mainMenu">조선시대 <span class="arrow">&#9660;</span></span>
                <ul class="submenu">
                    <li><a th:href="@{/board/list(boardType='조선시대')}" class="study-link">학습하기</a></li>
                    <li><a th:href="@{/quiz/list(quizType='조선시대')}" class="quiz-link">퀴즈풀기</a></li>
                </ul>
            </li>

            <li class="submenuBox">
                <span class="mainMenu">근대 <span class="arrow">&#9660;</span></span>
                <ul class="submenu">
                    <li><a th:href="@{/board/list(boardType='근대')}" class="study-link">학습하기</a></li>
                    <li><a th:href="@{/quiz/list(quizType='근대')}" class="quiz-link">퀴즈풀기</a></li>
                </ul>
            </li>

            <li class="submenuBox">
                <span class="mainMenu">현대 <span class="arrow">&#9660;</span></span>
                <ul class="submenu lastUl">
                    <li><a th:href="@{/board/list(boardType='현대')}" class="study-link">학습하기</a></li>
                    <li><a th:href="@{/quiz/list(quizType='현대')}" class="quiz-link">퀴즈풀기</a></li>
                </ul>
            </li>
        </ul>
    </div>
</div>

<div id="container">
    <div id="post-box">
        <!-- 카테고리명 -->
        <h2 class="post-category" th:text="${board.boardType}">카테고리</h2>

        <!-- 제목과 관리 버튼 -->
        <div class="post-header">
            <h1 class="post-title" th:text="${board.title}">게시글 제목</h1>
            <div class="post-actions" th:if="${loginUser != null and loginUser.userType == '관리자'}">
                <a th:href="@{/board/edit(boardId=${board.boardId})}">
                    <button type="button">수정</button>
                </a>
                <form th:action="@{/board/delete}" method="post" style="display: inline;">
                    <input type="hidden" name="boardId" th:value="${board.boardId}">
                    <button type="submit" onclick="return confirm('정말 삭제하시겠습니까?')">삭제</button>
                </form>
            </div>
        </div>

        <!-- 메타 정보 -->
        <div class="post-meta">
            <span th:text="${board.name}">작성자</span>
            <span th:if="${board.created}" th:text="${#dates.format(board.created, 'yyyy-MM-dd')}">작성일</span>
        </div>

        <!-- [추가] 영상 섹션: 썸네일 → 클릭 시 iFrame 로드 -->
        <div th:if="${board.videoUrl}" class="post-video video-field"
             th:attr="data-embed=${board.videoUrl}"
             style="margin:16px 0;">
            <button type="button" class="thumb-btn"
                    style="padding:0;border:0;background:none;cursor:pointer;position:relative;">
                <img class="thumb" alt="video thumbnail"
                     style="max-width:100%;width:560px;max-height:315px;display:block;margin:0 auto;">
                <div style="position:absolute;bottom:10px;left:10px;font-size:16px;background:rgba(0,0,0,.6);color:#fff;padding:6px 10px;border-radius:6px;">
                    ▶ 재생
                </div>
            </button>
            <div class="iframe-host" style="margin-top:8px;"></div>
        </div>

        <!-- 본문 내용 -->
        <div class="post-content">
            <div th:utext="${board.content}">게시글 내용이 여기에 표시됩니다.</div>
        </div>

        <!-- 학습 완료 버튼 -->
        <div class="done-btn-box" th:if="${loginUser != null}">
            <button id="done-btn" disabled>학습완료</button>
        </div>

        <!-- 학습 완료 모달 -->
        <div id="doneModal" class="done-modal">
            <div class="done-modal-content">
                <span class="done-closeBtn">&times;</span>
                <h2>학습 완료</h2>
                <p>학습이 완료되었습니다.</p>
                <p>퀴즈로 바로 이동하시겠습니까?</p>
                <div class="yes-no-btn-box">
                    <button id="yes-quiz-btn">예</button>
                    <button id="no-quiz-btn">아니오</button>
                </div>
            </div>
        </div>

        <!-- 댓글 영역 -->
        <div class="comment-section" th:if="${board.boardType != '공지사항'}">
            <h4>댓글</h4>
            <ul id="comment-list">
                <li th:each="comment : ${comments}" class="comment">
                    <div class="comment-content">
                        <p>
                            <strong th:text="${comment.name}">작성자</strong> |
                            <span th:text="${#temporals.format(comment.date, 'yyyy-MM-dd')}">작성일</span>
                        </p>
                        <p th:text="${comment.comment}">댓글 내용</p>
                        <div style="margin-top: 10px;">
                            <button th:if="${loginUser != null}"
                                    class="reply-btn"
                                    th:onclick="|toggleReplyForm(${comment.commentId})|"
                                    th:data-id="${comment.commentId}">답글</button>

                            <form th:if="${loginUser != null and (loginUser.userId == comment.userId or loginUser.userType == '관리자')}"
                                  th:action="@{/board/comment/delete}" method="post" style="display: inline;">
                                <input type="hidden" name="commentId" th:value="${comment.commentId}">
                                <input type="hidden" name="boardId" th:value="${board.boardId}">
                                <button type="submit" onclick="return confirm('댓글을 삭제하시겠습니까?')">삭제</button>
                            </form>
                        </div>
                    </div>

                    <ul class="replies" th:if="${repliesMap[comment.commentId] != null and !repliesMap[comment.commentId].isEmpty()}">
                        <li th:each="reply : ${repliesMap[comment.commentId]}" class="comment">
                            <div class="comment-content">
                                <p>
                                    <strong th:text="${reply.name}">답글 작성자</strong> |
                                    <span th:text="${#temporals.format(reply.date, 'yyyy-MM-dd')}">작성일</span>
                                </p>
                                <p th:text="${reply.reply}">답글 내용</p>
                                <form th:if="${loginUser != null and (loginUser.userId == reply.userId or loginUser.userType == '관리자')}"
                                      th:action="@{/board/reply/delete}" method="post" style="display: inline;">
                                    <input type="hidden" name="replyId" th:value="${reply.replyId}">
                                    <input type="hidden" name="boardId" th:value="${board.boardId}">
                                    <button type="submit" onclick="return confirm('답글을 삭제하시겠습니까?')">삭제</button>
                                </form>
                            </div>
                        </li>
                    </ul>

                    <div th:id="|reply-form-${comment.commentId}|" class="reply-form" style="display: none;">
                        <form th:action="@{/board/reply}" method="post" th:if="${loginUser != null}">
                            <input type="hidden" name="commentId" th:value="${comment.commentId}">
                            <input type="hidden" name="boardId" th:value="${board.boardId}">
                            <textarea name="content" class="reply-input" placeholder="답글을 입력하세요" required></textarea>
                            <div style="text-align: right; margin-top: 10px;">
                                <button type="submit" class="reply-submit">등록</button>
                                <button type="button" th:onclick="|toggleReplyForm(${comment.commentId})|" style="margin-left: 10px; background-color: #ddd; border: 1px solid #aaa; padding: 6px 14px; border-radius: 6px; cursor: pointer;">취소</button>
                            </div>
                        </form>
                    </div>
                </li>
            </ul>
        </div>

        <!-- 댓글 작성 -->
        <div class="comment-form" th:if="${loginUser != null and board.boardType != '공지사항'}">
            <form th:action="@{/board/detail}" method="post">
                <input type="hidden" name="boardId" th:value="${board.boardId}">
                <textarea id="comment-input" name="content" placeholder="댓글을 입력하세요" required></textarea>
                <button id="comment-submit" type="submit">등록</button>
            </form>
        </div>

        <!-- 로그인 안 된 경우 메시지 -->
        <div th:if="${loginUser == null and board.boardType != '공지사항'}" style="text-align: center; color: #777; font-style: italic; padding: 20px;">
            <p>댓글을 작성하려면 로그인이 필요합니다.</p>
        </div>
    </div>
</div>

<div id="footer">
    <ul>
        <li>대표전화: 042-222-2402</li>
        <li>주소: (34838) 대전 중구 중앙로121번길 20(방산빌딩 3층)</li>
        <li>운영시간: 평일 09:00 ~ 18:00 (주말·공휴일 휴무)</li>
        <li>© 2025 역사 한 걸음. All rights reserved.</li>
    </ul>
</div>

<!-- 서버에서 전달받은 데이터를 JavaScript로 변환 -->
<script th:inline="javascript">
    const boardId = /*[[${board.boardId}]]*/ 0;
    const isLoggedIn = /*[[${loginUser != null}]]*/ false;
</script>

<script>
    // 사이드바 토글
    document.querySelectorAll(".mainMenu").forEach(menu => {
        menu.addEventListener("click", () => {
            const parent = menu.parentElement;
            const submenu = parent.querySelector(".submenu");

            if (submenu.classList.contains("show")) {
                submenu.style.maxHeight = submenu.scrollHeight + "px";
                submenu.offsetHeight;
                submenu.classList.remove("show");
                submenu.style.maxHeight = "0px";
                parent.classList.remove("open");
            } else {
                submenu.classList.add("show");
                submenu.style.maxHeight = submenu.scrollHeight + "px";
                parent.classList.add("open");
            }
        });
    });

    function toggleReplyForm(commentId) {
        const replyForm = document.getElementById(`reply-form-${commentId}`);
        replyForm.style.display = (replyForm.style.display === 'none' || replyForm.style.display === '') ? 'block' : 'none';
        const textarea = replyForm.querySelector('textarea');
        if (textarea) textarea.focus();
    }

    // ====== 유튜브(상세) : 썸네일 먼저 → 클릭 시 iFrame 로드 ======
    (function(){
        const EMBED_ID_RE = /embed\/([A-Za-z0-9_-]{11})/;
        function extractFromEmbed(embedUrl){
            const m = String(embedUrl||'').match(EMBED_ID_RE);
            return m ? m[1] : null;
        }
        function thumbUrl(id){ return `https://img.youtube.com/vi/${id}/hqdefault.jpg`; }
        function iframeHtml(embed){
            return `<iframe width="560" height="315" frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                    referrerpolicy="strict-origin-when-cross-origin" allowfullscreen loading="lazy"
                    src="${embed}"></iframe>`;
        }

        document.addEventListener('DOMContentLoaded', function(){
            const field = document.querySelector('.post-video.video-field');
            if (!field) return;

            const embed = field.getAttribute('data-embed');
            const id = extractFromEmbed(embed);
            const thumb = field.querySelector('.thumb');
            const btn = field.querySelector('.thumb-btn');
            const host = field.querySelector('.iframe-host');

            if (id && thumb){
                thumb.src = thumbUrl(id);
            }

            if (btn && host && embed){
                btn.addEventListener('click', function(){
                    host.innerHTML = iframeHtml(embed);
                    // 썸네일 버튼은 감춰도 되고 유지해도 됨. 여기선 감춤.
                    btn.style.display = 'none';
                }, { passive: true });
            }
        });
    })();

    // ====== 10초 타이머 및 학습 완료 기능 ======
    function setupStudyTimer() {
        if (!isLoggedIn) return;

        const doneBtn = document.getElementById("done-btn");

        if (!doneBtn) return;

        // 10초 후 버튼 활성화
        setTimeout(() => {
            doneBtn.disabled = false;
            doneBtn.style.backgroundColor = "#28a745";
        }, 10000); // 10초
    }

    // 학습 완료 처리 함수
    async function completeStudy() {
        if (!isLoggedIn) {
            alert('로그인이 필요합니다.');
            return;
        }

        try {
            const response = await fetch('/board/complete-study', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `boardId=${boardId}`
            });

            const result = await response.json();

            if (result.status === 'success') {
                console.log('학습 완료 기록 성공');
                // 모달 표시
                document.getElementById("doneModal").style.display = "flex";
            } else {
                console.error('학습 완료 기록 실패:', result.message);
                alert('학습 완료 처리 중 오류가 발생했습니다.');
            }
        } catch (error) {
            console.error('학습 완료 처리 중 오류:', error);
            alert('학습 완료 처리 중 오류가 발생했습니다.');
        }
    }

    // 학습 완료 모달
    function setupDoneModal() {
        const doneBtn = document.getElementById("done-btn");
        const doneModal = document.getElementById("doneModal");
        const doneCloseBtn = doneModal.querySelector(".done-closeBtn");
        const yesBtn = document.getElementById("yes-quiz-btn");
        const noBtn = document.getElementById("no-quiz-btn");

        if (!doneBtn || !doneModal) return;

        // 현재 카테고리 가져오기
        function getCurrentCategory() {
            const categoryElement = document.querySelector(".post-category");
            return categoryElement ? categoryElement.textContent.trim() : "";
        }

        // 모달 열기 (학습 완료 처리)
        doneBtn.addEventListener("click", async () => {
            if (doneBtn.disabled) return;
            await completeStudy();
        });

        // 모달 닫기 (X 버튼)
        doneCloseBtn.addEventListener("click", () => {
            doneModal.style.display = "none";
        });

        // "예" 버튼 → 퀴즈 목록 이동
        yesBtn.addEventListener("click", () => {
            const category = getCurrentCategory();
            window.location.href = `/quiz/list?quizType=${encodeURIComponent(category)}`;
        });

        // "아니오" 버튼 → 학습 목록 이동
        noBtn.addEventListener("click", () => {
            const category = getCurrentCategory();
            window.location.href = `/board/list?boardType=${encodeURIComponent(category)}`;
        });

        // 모달 바깥 클릭 시 닫기
        window.addEventListener("click", (e) => {
            if (e.target === doneModal) {
                doneModal.style.display = "none";
            }
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
        setupStudyTimer();
        setupDoneModal();
    });
</script>
</body>
</html>