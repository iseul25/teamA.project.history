<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${board.title}">ê²Œì‹œê¸€ ë³´ê¸°</title>
    <link rel="stylesheet" th:href="@{/css/boardstyle.css}">
</head>
<body>
<header>
    <a th:href="@{/}">
        <img th:src="@{/img/mainLg2.png}" alt="ë©”ì¸ ë¡œê³ ">
    </a>
    <ul>
        <li><a th:href="@{/board/topic}">í•™ìŠµí•˜ê¸°</a></li>
        <li><a href="#">í€´ì¦ˆí’€ê¸°</a></li>
        <li><a href="#">ì¶œì„í•˜ê¸°</a></li>
        <li><a th:href="@{/pointshop}">í¬ì¸íŠ¸ ìƒì </a></li>
        <li><a th:href="@{/faq}">FAQ</a></li>
        <li><a th:href="@{/notice}">ê³µì§€ì‚¬í•­</a></li>
    </ul>
</header>

<main>
    <!-- ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸° ë²„íŠ¼ -->
    <a th:href="@{/board/list(boardType=${board.boardType})}" class="list-button">ğŸ“‹ ê²Œì‹œê¸€ ëª©ë¡</a>

    <!-- ê²Œì‹œê¸€ ì œëª© -->
    <h2 id="post-title" th:text="${board.title}">ê²Œì‹œê¸€ ì œëª©</h2>
    <hr />

    <!-- ê²Œì‹œê¸€ ë‚´ìš© (HTML í—ˆìš©ìœ¼ë¡œ ë³€ê²½) -->
    <div id="post-content" th:utext="${board.content}">ê²Œì‹œê¸€ ë‚´ìš©</div>

    <!-- ì´ë¯¸ì§€ë¥¼ ë‚´ìš©ì— ì¶”ê°€í•˜ê¸° ìœ„í•œ ìˆ¨ê²¨ì§„ ë°ì´í„° -->
    <script th:if="${board.imgUrl != null and board.imgUrl != ''}" th:inline="javascript">
        window.boardImageUrl = /*[[${board.imgUrl}]]*/ '';
        window.boardImageDesc = /*[[${board.imgDescription}]]*/ '';
    </script>

    <!-- ì´ë¯¸ì§€ëŠ” JavaScriptë¡œ ë‚´ìš©ì— í¬í•¨ì‹œí‚´ -->

    <!-- ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ (ê´€ë¦¬ìë§Œ í‘œì‹œ) -->
    <div id="post-actions" class="post-actions"
         th:if="${loginUser != null and loginUser.userType == 'ê´€ë¦¬ì'}">
        <button id="edit-btn" th:onclick="|location.href='@{/board/edit(boardId=${board.boardId})}'|">ìˆ˜ì •</button>

        <!-- ì‚­ì œëŠ” POST ë°©ì‹ìœ¼ë¡œ í¼ ì‚¬ìš© -->
        <form th:action="@{/board/delete}" method="post" style="display: inline;">
            <input type="hidden" name="boardId" th:value="${board.boardId}">
            <button id="delete-btn" type="submit" onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ì‚­ì œ</button>
        </form>
    </div>

    <!-- ëŒ“ê¸€ ì„¹ì…˜ (ê³µì§€ì‚¬í•­ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ í‘œì‹œ) -->
    <div th:if="${board.boardType != 'ê³µì§€ì‚¬í•­'}">
        <h3>ëŒ“ê¸€</h3>
        <ul id="comment-list">
            <li th:each="comment : ${comments}" class="comment-item">
                <div class="comment-content">
                    <strong th:text="${comment.name}">ì‘ì„±ì</strong>
                    <div th:text="${comment.comment}">ëŒ“ê¸€ ë‚´ìš©</div>
                    <small th:text="${#temporals.format(comment.date, 'yyyy-MM-dd')}">ì‘ì„±ì¼</small>

                    <div class="comment-actions">
                        <!-- ë‹µê¸€ ë²„íŠ¼ -->
                        <button th:if="${loginUser != null}"
                                th:onclick="|toggleReplyForm(${comment.commentId})|"
                                class="reply-btn">ë‹µê¸€</button>

                        <!-- ë³¸ì¸ ëŒ“ê¸€ì´ê±°ë‚˜ ê´€ë¦¬ìì¸ ê²½ìš° ì‚­ì œ ë²„íŠ¼ í‘œì‹œ -->
                        <form th:if="${loginUser != null and (loginUser.userId == comment.userId or loginUser.userType == 'ê´€ë¦¬ì')}"
                              th:action="@{/board/comment/delete}" method="post" style="display: inline;">
                            <input type="hidden" name="commentId" th:value="${comment.commentId}">
                            <input type="hidden" name="boardId" th:value="${board.boardId}">
                            <button type="submit" onclick="return confirm('ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ì‚­ì œ</button>
                        </form>
                    </div>
                </div>

                <!-- ë‹µê¸€ ëª©ë¡ -->
                <div th:if="${repliesMap[comment.commentId] != null and !repliesMap[comment.commentId].isEmpty()}"
                     class="replies-list">
                    <div th:each="reply : ${repliesMap[comment.commentId]}" class="reply-item">
                        <strong th:text="${reply.name}">ë‹µê¸€ ì‘ì„±ì</strong>
                        <div th:text="${reply.reply}">ë‹µê¸€ ë‚´ìš©</div>
                        <small th:text="${#temporals.format(reply.date, 'yyyy-MM-dd')}">ì‘ì„±ì¼</small>

                        <!-- ë‹µê¸€ ì‚­ì œ ë²„íŠ¼ -->
                        <form th:if="${loginUser != null and (loginUser.userId == reply.userId or loginUser.userType == 'ê´€ë¦¬ì')}"
                              th:action="@{/board/reply/delete}" method="post" style="display: inline;">
                            <input type="hidden" name="replyId" th:value="${reply.replyId}">
                            <input type="hidden" name="boardId" th:value="${board.boardId}">
                            <button type="submit" onclick="return confirm('ë‹µê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ì‚­ì œ</button>
                        </form>
                    </div>
                </div>

                <!-- ë‹µê¸€ ì‘ì„± í¼ -->
                <div th:id="|reply-form-${comment.commentId}|" class="reply-form" style="display: none;">
                    <form th:action="@{/board/reply}" method="post" th:if="${loginUser != null}">
                        <input type="hidden" name="commentId" th:value="${comment.commentId}">
                        <input type="hidden" name="boardId" th:value="${board.boardId}">
                        <textarea name="content" placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" required></textarea>
                        <div class="reply-form-buttons">
                            <button type="submit">ë‹µê¸€ ë“±ë¡</button>
                            <button type="button" th:onclick="|toggleReplyForm(${comment.commentId})|">ì·¨ì†Œ</button>
                        </div>
                    </form>
                </div>
            </li>
        </ul>

        <p id="editing-status" style="color: red; font-weight: bold; display: none;">âœï¸ ëŒ“ê¸€ ìˆ˜ì • ì¤‘...</p>

        <!-- ëŒ“ê¸€ ì‘ì„± í¼ -->
        <form id="comment-form" th:action="@{/board/detail}" method="post" th:if="${loginUser != null}">
            <input type="hidden" name="boardId" th:value="${board.boardId}">
            <textarea id="comment-content" name="content" placeholder="ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" required></textarea>
            <button type="submit">ëŒ“ê¸€ ë“±ë¡</button>
        </form>

        <!-- ë¡œê·¸ì¸ ì•ˆ ëœ ê²½ìš° ë©”ì‹œì§€ -->
        <div th:if="${loginUser == null}">
            <p>ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
        </div>
    </div>


</main>

<div id="footer">
    <ul>
        <li>ëŒ€í‘œì „í™”: 042-222-2402</li>
        <li>ì£¼ì†Œ: (34838) ëŒ€ì „ ì¤‘êµ¬ ì¤‘ì•™ë¡œ121ë²ˆê¸¸ 20(ë°©ì‚°ë¹Œë”© 3ì¸µ)</li>
        <li>ìš´ì˜ì‹œê°„: í‰ì¼ 09:00 ~ 18:00 (ì£¼ë§Â·ê³µíœ´ì¼ íœ´ë¬´)</li>
        <li>Â© 2025 ì—­ì‚¬ í•œ ê±¸ìŒ. All rights reserved.</li>
    </ul>
</div>

<script th:src="@{/js/board.js}"></script>
<script>
    function replyToComment(userName) {
        const textarea = document.getElementById('comment-content');
        // ë¡œê·¸ì¸ ì²´í¬
        if (!textarea) return;

        // ì´ë¯¸ ë©˜ì…˜ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ì¶”ê°€
        const currentValue = textarea.value;
        const mention = '@' + userName + ' ';

        // ì´ë¯¸ ê°™ì€ ë©˜ì…˜ì´ ìˆìœ¼ë©´ ì¶”ê°€í•˜ì§€ ì•ŠìŒ
        if (!currentValue.includes(mention)) {
            textarea.value = mention + currentValue;
        }

        // ì»¤ì„œë¥¼ í…ìŠ¤íŠ¸ ëìœ¼ë¡œ ì´ë™í•˜ê³  í¬ì»¤ìŠ¤
        textarea.focus();
        textarea.setSelectionRange(textarea.value.length, textarea.value.length);

        // í…ìŠ¤íŠ¸ ì˜ì—­ìœ¼ë¡œ ìŠ¤í¬ë¡¤
        textarea.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // ë‹µê¸€ í¼ í† ê¸€ í•¨ìˆ˜
    function toggleReplyForm(commentId) {
        const replyForm = document.getElementById(`reply-form-${commentId}`);
        if (replyForm.style.display === 'none' || replyForm.style.display === '') {
            replyForm.style.display = 'block';
            // ë‹µê¸€ textareaì— í¬ì»¤ìŠ¤
            const textarea = replyForm.querySelector('textarea');
            if (textarea) {
                textarea.focus();
            }
        } else {
            replyForm.style.display = 'none';
        }
    }

    // ì´ë¯¸ì§€ë¥¼ ë‚´ìš©ì˜ ì œì¼ ìœ„ìª½ì— ì¶”ê°€í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸
    document.addEventListener('DOMContentLoaded', function() {
        const content = document.getElementById('post-content');

        // window ê°ì²´ì—ì„œ ì´ë¯¸ì§€ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const imgUrl = window.boardImageUrl;
        const imgDesc = window.boardImageDesc;

        console.log('ì´ë¯¸ì§€ URL:', imgUrl); // ë””ë²„ê¹…ìš©
        console.log('ì´ë¯¸ì§€ ì„¤ëª…:', imgDesc); // ë””ë²„ê¹…ìš©

        // ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ í•­ìƒ ë‚´ìš© ë§¨ ìœ„ì— ì¶”ê°€
        if (imgUrl && imgUrl !== '' && imgUrl !== 'null') {
            // ê¸°ì¡´ì— ì´ë¯¸ì§€ê°€ ìˆëŠ”ì§€ í™•ì¸
            if (!content.innerHTML.includes(imgUrl)) {
                const imgHtml = `<div style="text-align: center; margin: 0 0 15px 0;">
                                    <img src="${imgUrl}" alt="${imgDesc || ''}"
                                         style="max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 5px; display: inline-block;">
                                    ${imgDesc && imgDesc !== '' && imgDesc !== 'null' ? `<p style="color: #666; font-style: italic; margin: 5px 0 0 0;">${imgDesc}</p>` : ''}
                                 </div>`;

                // ê¸°ì¡´ ë‚´ìš©ì˜ ì œì¼ ì•ì— ì´ë¯¸ì§€ ì¶”ê°€í•˜ê³  í…ìŠ¤íŠ¸ëŠ” ì™¼ìª½ ì •ë ¬
                content.innerHTML = imgHtml + '<div style="text-align: left;">' + content.innerHTML + '</div>';
            }
        } else {
            // ì´ë¯¸ì§€ê°€ ì—†ì–´ë„ í…ìŠ¤íŠ¸ëŠ” ì™¼ìª½ ì •ë ¬
            content.style.textAlign = 'left';
        }
    });
</script>
</body>
</html>