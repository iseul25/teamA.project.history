<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>학습 목록</title>
    <link rel="stylesheet" th:href="@{/css/listBoard.css}">
    <style>
        /* ▶︎영상 배지 스타일 */
        .video-badge{
            display:inline-block;
            margin-left:8px;
            padding:2px 6px;
            font-size:12px;
            line-height:1;
            color:#fff;
            background:#e53935;
            border-radius:10px;
            vertical-align:middle;
        }
        .post-link{ text-decoration: underline; color:#007bff; cursor: pointer; }
        .post-link:hover{ text-decoration: none; }
        .pagination button.disabled{ opacity:.4; cursor:not-allowed; }
        .pagination button.active{ font-weight:700; text-decoration:underline; }
    </style>
</head>
<body>
<header>
    <a th:href="@{/}">
        <img th:src="@{/img/mainLg2.png}" alt="메인 로고">
    </a>
    <ul>
        <li><a th:href="@{/board/topic}" class="active">학습하기</a></li>
        <li><a th:href="@{/quiz/topic}">퀴즈풀기</a></li>
        <li><a th:href="@{/attend}">출석하기</a></li>
        <li><a th:href="@{/pointStore}">포인트 상점</a></li>
        <li><a th:href="@{/faq}">FAQ</a></li>
        <li><a th:href="@{/notice}">공지사항</a></li>
    </ul>
    <!-- Thymeleaf로 로그인 상태 처리 -->
    <div id="user" th:if="${session.loginUser != null}">
        <!-- 관리자인 경우 -->
        <a th:if="${session.loginUser.userType == '관리자'}"
           th:href="@{/admin/users}"
           class="userName-link"
           th:text="${session.loginUser.name} + '님'"></a>

        <!-- 일반 사용자인 경우 -->
        <a th:unless="${session.loginUser.userType == '관리자'}"
           th:href="@{/user/myPage}"
           class="userName-link"
           th:text="${session.loginUser.name} + '님'"></a>
    </div>
</header>

<div id="sidebar">
    <div class="sideBox">
        <ul>
            <li class="submenuBox">
                <span class="mainMenu">
                    선사시대
                    <span class="arrow">&#9660;</span>
                </span>
                <ul class="submenu">
                    <li><a th:href="@{/board/list(boardType='선사시대')}" class="study-link">학습하기</a></li>
                    <li><a th:href="@{/quiz/list(quizType='선사시대')}" class="quiz-link">퀴즈풀기</a></li>
                </ul>
            </li>

            <li class="submenuBox">
                <span class="mainMenu">
                    고조선과 여러 나라
                    <span class="arrow">&#9660;</span>
                </span>
                <ul class="submenu">
                    <li><a th:href="@{/board/list(boardType='고조선과 여러 나라')}" class="study-link">학습하기</a></li>
                    <li><a th:href="@{/quiz/list(quizType='고조선과 여러 나라')}" class="quiz-link">퀴즈풀기</a></li>
                </ul>
            </li>

            <li class="submenuBox">
                <span class="mainMenu">
                    삼국과 가야
                    <span class="arrow">&#9660;</span>
                </span>
                <ul class="submenu">
                    <li><a th:href="@{/board/list(boardType='삼국과 가야')}" class="study-link">학습하기</a></li>
                    <li><a th:href="@{/quiz/list(quizType='삼국과 가야')}" class="quiz-link">퀴즈풀기</a></li>
                </ul>
            </li>

            <li class="submenuBox">
                <span class="mainMenu">
                    남북극시대
                    <span class="arrow">&#9660;</span>
                </span>
                <ul class="submenu">
                    <li><a th:href="@{/board/list(boardType='남북극시대')}" class="study-link">학습하기</a></li>
                    <li><a th:href="@{/quiz/list(quizType='남북극시대')}" class="quiz-link">퀴즈풀기</a></li>
                </ul>
            </li>

            <li class="submenuBox">
                <span class="mainMenu">
                    고려시대
                    <span class="arrow">&#9660;</span>
                </span>
                <ul class="submenu">
                    <li><a th:href="@{/board/list(boardType='고려시대')}" class="study-link">학습하기</a></li>
                    <li><a th:href="@{/quiz/list(quizType='고려시대')}" class="quiz-link">퀴즈풀기</a></li>
                </ul>
            </li>

            <li class="submenuBox">
                <span class="mainMenu">
                    조선시대
                    <span class="arrow">&#9660;</span>
                </span>
                <ul class="submenu">
                    <li><a th:href="@{/board/list(boardType='조선시대')}" class="study-link">학습하기</a></li>
                    <li><a th:href="@{/quiz/list(quizType='조선시대')}" class="quiz-link">퀴즈풀기</a></li>
                </ul>
            </li>

            <li class="submenuBox">
                <span class="mainMenu">
                    근대
                    <span class="arrow">&#9660;</span>
                </span>
                <ul class="submenu">
                    <li><a th:href="@{/board/list(boardType='근대')}" class="study-link">학습하기</a></li>
                    <li><a th:href="@{/quiz/list(quizType='근대')}" class="quiz-link">퀴즈풀기</a></li>
                </ul>
            </li>

            <li class="submenuBox">
                <span class="mainMenu">
                    현대
                    <span class="arrow">&#9660;</span>
                </span>
                <ul class="submenu lastUl">
                    <li><a th:href="@{/board/list(boardType='현대')}" class="study-link">학습하기</a></li>
                    <li><a th:href="@{/quiz/list(quizType='현대')}" class="quiz-link">퀴즈풀기</a></li>
                </ul>
            </li>
        </ul>
    </div>
</div>

<div id="container">
    <div class="listBox">
        <div class="list-title" id="board-title" th:text="${selectedBoardType + ' 학습'}">게시판</div>
        <table class="list-table">
            <thead>
            <tr>
                <th style="width: 120px;">번호</th>
                <th style="width: auto;">제목</th>
                <th style="width: 180px;">작성자</th>
                <th style="width: 180px;">등록일</th>
            </tr>
            </thead>
            <tbody id="list-body">
            <!-- JavaScript로 동적 생성 -->
            </tbody>
        </table>
        <div class="pagination-container">
            <div id="pagination" class="pagination">
                <!-- JavaScript로 동적 생성 -->
            </div>

            <!-- 관리자 글 작성 버튼 -->
            <div id="post-btn-box">
                <a th:if="${session.loginUser != null and session.loginUser.userType == '관리자'}"
                   th:href="@{/board/create(boardType=${selectedBoardType})}"
                   id="create-post-btn">글쓰기</a>
            </div>
        </div>
    </div>
</div>

<div id="footer">
    <ul>
        <li>대표전화: 042-222-2402</li>
        <li>주소: (34838) 대전 중구 중앙로121번길 20(방산빌딩 3층)</li>
        <li>운영시간: 평일 09:00 ~ 18:00 (주말·공휴일 휴무)</li>
        <li>© 2025 역사 한 걸음. All rights reserved.</li>
    </ul>
</div>

<!-- 서버에서 전달받은 데이터를 JavaScript로 변환 -->
<script th:inline="javascript">
    // 서버에서 전달된 전체 목록 (리스트/페이징용). 객체에 videoUrl 포함돼 있어야 함!
    let allBoardsData = /*[[${allBoards != null ? allBoards : boards}]]*/ [];

    // 페이징 관련 변수
    const pageSize = 10;
    let currentPage = 1;

    // 로그인 사용자 정보
    const isLoggedIn = /*[[${session.loginUser != null}]]*/ false;
</script>

<script>
    // 사이드바 메인메뉴 클릭 시 서브메뉴 토글
    document.querySelectorAll(".mainMenu").forEach(menu => {
        menu.addEventListener("click", () => {
            const parent = menu.parentElement;
            const submenu = parent.querySelector(".submenu");

            if (submenu.classList.contains("show")) {
                submenu.style.maxHeight = submenu.scrollHeight + "px";
                submenu.offsetHeight;
                submenu.classList.remove("show");
                submenu.style.maxHeight = "0px";
                parent.classList.remove("open");
            } else {
                submenu.classList.add("show");
                submenu.style.maxHeight = submenu.scrollHeight + "px";
                parent.classList.add("open");
            }
        });
    });

    // 안전한 텍스트 이스케이프 (XSS 방지)
    function escapeHtml(str){
        return String(str ?? '')
            .replace(/&/g,'&amp;').replace(/</g,'&lt;')
            .replace(/>/g,'&gt;').replace(/"/g,'&quot;')
            .replace(/'/g,'&#39;');
    }

    // 유튜브 URL 유효 여부(간단 체크)
    const YT_RE = /(?:youtu\.be\/|youtube\.com\/(?:watch\?v=|embed\/|shorts\/))([A-Za-z0-9_-]{11})/;
    function hasVideo(url){
        if(!url) return false;
        return YT_RE.test(String(url).trim());
    }

    // 학습 시작 기록 후 상세페이지 이동 함수
    async function startStudyAndNavigate(boardId) {
        // 로그인하지 않은 경우 로그인 페이지로 이동
        if (!isLoggedIn) {
            alert('로그인이 필요한 서비스입니다.');
            window.location.href = '/';
            return;
        }

        // ✅ 관리자 여부 확인 추가
        const isAdmin = /*[[${session.loginUser != null and session.loginUser.userType == '관리자'}]]*/ false;

        // ✅ 관리자는 학습 기록 없이 바로 이동
        if (isAdmin) {
            window.location.href = `/board/detail?boardId=${boardId}`;
            return;
        }

        // 일반 사용자만 학습 시작 기록
        try {
            const response = await fetch('/board/start-study', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `boardId=${boardId}`
            });

            const result = await response.json();
            console.log('학습 시작 기록 결과:', result);

            // 성공 여부와 관계없이 상세페이지로 이동
            window.location.href = `/board/detail?boardId=${boardId}`;
        } catch (error) {
            // 오류 발생해도 상세페이지로 이동
            console.error('학습 시작 기록 중 오류:', error);
            window.location.href = `/board/detail?boardId=${boardId}`;
        }
    }

    // 테이블 렌더링 함수 (JS 페이징용)
    function renderTable(page = 1) {
        currentPage = page;
        const tbody = document.getElementById("list-body");
        tbody.innerHTML = "";

        const start = (currentPage - 1) * pageSize;
        const end = start + pageSize;
        const pageData = allBoardsData.slice(start, end);

        // 게시글이 없는 경우 메시지만 표시
        if (allBoardsData.length === 0) {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td colspan="4" style="text-align: center; padding: 50px;">게시글이 없습니다</td>`;
            tbody.appendChild(tr);
        } else {
            // 게시글이 있는 경우 현재 페이지 데이터 렌더링
            pageData.forEach((board, index) => {
                const tr = document.createElement("tr");
                const displayNumber = start + index + 1;

                // 날짜 포맷
                const date = new Date(board.created);
                const formattedDate = isNaN(date.getTime())
                    ? (board.created || '')
                    : date.toISOString().split('T')[0];

                // 제목+영상 배지 (클릭 이벤트 추가)
                const titleHtml = `
                    <span class="post-link" onclick="startStudyAndNavigate(${board.boardId})">${escapeHtml(board.title)}</span>
                    ${hasVideo(board.videoUrl) ? '<span class="video-badge" aria-label="영상 포함">▶︎영상</span>' : ''}
                `;

                tr.innerHTML = `
                    <td>${displayNumber}</td>
                    <td>${titleHtml}</td>
                    <td>${escapeHtml(board.name)}</td>
                    <td>${escapeHtml(formattedDate)}</td>
                `;
                tbody.appendChild(tr);
            });

            // 현재 페이지에서 부족한 행만 빈 행으로 채우기
            const emptyRows = pageSize - pageData.length;
            for (let i = 0; i < emptyRows; i++) {
                const tr = document.createElement("tr");
                tr.innerHTML = `<td>&nbsp;</td><td></td><td></td><td></td>`;
                tbody.appendChild(tr);
            }
        }

        renderPagination();
    }

    // 페이지네이션 렌더링 함수
    function renderPagination() {
        const paginationDiv = document.getElementById("pagination");
        paginationDiv.innerHTML = "";

        const totalPages = Math.ceil(allBoardsData.length / pageSize) || 1;

        // ◀ 이전 버튼
        const prevBtn = document.createElement("button");
        prevBtn.textContent = "◀";
        prevBtn.className = currentPage === 1 ? "disabled" : "";
        prevBtn.disabled = currentPage === 1;
        if (currentPage > 1) prevBtn.addEventListener("click", () => renderTable(currentPage - 1));
        paginationDiv.appendChild(prevBtn);

        // 페이지 번호 버튼들
        for (let i = 1; i <= totalPages; i++) {
            const btn = document.createElement("button");
            btn.textContent = i;
            btn.className = i === currentPage ? "active" : "";
            btn.addEventListener("click", () => renderTable(i));
            paginationDiv.appendChild(btn);
        }

        // ▶ 다음 버튼
        const nextBtn = document.createElement("button");
        nextBtn.textContent = "▶";
        nextBtn.className = currentPage === totalPages ? "disabled" : "";
        nextBtn.disabled = currentPage === totalPages;
        if (currentPage < totalPages) nextBtn.addEventListener("click", () => renderTable(currentPage + 1));
        paginationDiv.appendChild(nextBtn);
    }

    // 페이지 로드 시 초기화
    document.addEventListener('DOMContentLoaded', function() {
        renderTable();
    });
</script>
</body>
</html>