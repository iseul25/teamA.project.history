<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>포인트 상점</title>
    <link rel="stylesheet" href="/css/pointStore.css">
</head>

<body>
<header>
    <a href="/home">
        <img src="/img/mainLg2.png" alt="메인 로고">
    </a>
    <ul>
        <li><a href="/board/topic">학습하기</a></li>
        <li><a href="/quiz/topic">퀴즈풀기</a></li>
        <li><a href="/attend" onclick="checkLoginAndAttend(event)">출석하기</a></li>
        <li><a href="/pointStore" class="active">포인트 상점</a></li>
        <li><a href="/faq">FAQ</a></li>
        <li><a href="/notice">공지사항</a></li>
    </ul>

    <div id="user" style="display: none;"> <a href="/user/myPage" id="userName-link">홍길동 님</a>
        <span id="userPoint">| 10000 P</span>
    </div>
</header>
<div id="sidebar">
    <div class="side-box">
        <ul>
            <li class="main-box">
                    <span class="main-menu">
                        <a href="#" class="category-link" data-category="drink">&#129380; 음료</a>
                    </span>
            </li>
            <li class="main-box">
                    <span class="main-menu">
                        <a href="#" class="category-link" data-category="C-store">&#127978; 편의점</a>
                    </span>
            </li>
            <li class="main-box">
                    <span class="main-menu">
                        <a href="#" class="category-link" data-category="movie">&#127916; 영화</a>
                    </span>
            </li>
            <li class="main-box">
                    <span class="main-menu">
                        <a href="#" class="category-link" data-category="gift-card">&#127873; 상품권</a>
                    </span>
            </li>
        </ul>
    </div>
</div>
<div id="container">
    <div id="product-box" data-category="drink">
        <div class="product-title" data-category="drink">
        </div>
        <div class="product-content">
            <div class="product-list">
            </div>
        </div>
        <div class="pagination-box">
            <div id="pagination" class="pagination"></div>
        </div>
    </div>
</div>
<div id="footer">
    <ul>
        <li>대표전화: 042-222-2402</li>
        <li>주소: (34838) 대전 중구 중앙로121번길 20(방산빌딩 3층)</li>
        <li>운영시간: 평일 09:00 ~ 18:00 (주말·공휴일 휴무)</li>
        <li>© 2025 역사 한 걸음. All rights reserved.</li>
    </ul>
</div>
</body>
<script>
    // 전역 변수로 로그인 상태를 저장
    let isLoggedIn = false;

    // 전역 변수
    const pageSize = 8; // 한 페이지에 보여줄 상품 개수
    let currentPage = 1;
    let currentCategory = "drink"; // 기본 카테고리
    let currentBrand = "all";      // 기본 브랜드 (전체)
    let allProducts = []; // 서버에서 불러온 모든 상품 데이터를 저장할 배열

    // 카테고리별 브랜드 목록
    const categoryInfo = {
        "drink": {
            title: "음료",
            brands: [
                { key: "all", label: "전체" },
                { key: "compose", label: "컴포즈" },
                { key: "mega", label: "메가커피" },
                { key: "starbucks", label: "스타벅스" },
                { key: "ediya", label: "이디야" },
                { key: "twosome", label: "투썸플레이스" }
            ]
        },
        "C-store": {
            title: "편의점",
            brands: [
                { key: "all", label: "전체" },
                { key: "cu", label: "CU" },
                { key: "gs25", label: "GS25" },
                { key: "7-Eleven", label: "세븐일레븐" },
                { key: "emart24", label: "이마트24" }
            ]
        },
        "movie": {
            title: "영화",
            brands: [
                { key: "all", label: "전체" },
                { key: "cgv", label: "CGV" },
                { key: "Megabox", label: "메가박스" },
                { key: "Lotte", label: "롯데시네마" }
            ]
        },
        "gift-card": {
            title: "상품권",
            brands: [
                { key: "all", label: "전체" },
                { key: "Kyobo", label: "교보문고" },
                { key: "culture", label: "컬쳐랜드" },
                { key: "Booknlife", label: "북앤라이프" }
            ]
        }
    };

    // 전역 변수 초기화
    async function checkLogin() {
        try {
            const response = await fetch("/api/check-login", {
                credentials: "include"
            });
            const data = await response.json();

            const userDiv = document.getElementById("user");
            const usernameLink = document.getElementById("userName-link");
            const userPointSpan = document.getElementById("userPoint");

            if (data.isLoggedIn) {
                isLoggedIn = true;
                if (data.role === "admin") {
                    // 관리자 계정
                    usernameLink.textContent = "관리자";
                    usernameLink.href = "/admin/dashboard.html"; // 관리자 전용 페이지
                    userPointSpan.textContent = ""; // 관리자에선 포인트 안 보이게
                } else {
                    // 일반 유저 계정
                    usernameLink.textContent = data.username;
                    usernameLink.href = "/user/myPage"; // 마이페이지
                    // 포인트 표시
                    userPointSpan.textContent = ` |  ${data.point} P`;
                }
                userDiv.style.display = "block";
            } else {
                isLoggedIn = false;
                userDiv.style.display = "none";  // 로그인 안 했을 때
            }
        } catch (err) {
            console.error("로그인 체크 에러:", err);
            isLoggedIn = false; // 에러 발생 시에도 비로그인 상태로 처리
        }
    }

    // 출석하기 버튼 클릭 이벤트 핸들러
    function checkLoginAndAttend(event) {
        event.preventDefault(); // 기본 링크 이동을 막음

        if (isLoggedIn) {
            // 로그인 상태면 출석 페이지로 이동
            window.location.href = '/attend';
        } else {
            // 비로그인 상태면 팝업 표시
            alert('로그인 해주세요.');
        }
    }

    function renderTitle() {
        const titleBox = document.querySelector(".product-title");
        titleBox.innerHTML = ""; // 초기화

        const info = categoryInfo[currentCategory];
        if (!info) return;

        // 제목 + 브랜드 목록 ul 생성
        const ul = document.createElement("ul");

        // 메인 타이틀
        const mainLi = document.createElement("li");
        mainLi.classList.add("main-title");
        mainLi.textContent = info.title;
        ul.appendChild(mainLi);

        // 브랜드 목록
        info.brands.forEach(b => {
            const li = document.createElement("li");
            const a = document.createElement("a");
            a.href = "#";
            a.classList.add("brand-link");
            a.dataset.brand = b.key;
            a.textContent = b.label;

            // 현재 선택된 브랜드 강조
            if (currentBrand === b.key) {
                a.classList.add("active");
            }

            li.appendChild(a);
            ul.appendChild(li);
        });

        titleBox.appendChild(ul);

        // 새로 만들어진 brand-link에 다시 이벤트 바인딩
        titleBox.querySelectorAll(".brand-link").forEach(link => {
            link.addEventListener("click", e => {
                e.preventDefault();
                currentBrand = link.dataset.brand;
                renderTitle();
                renderTable(1);
            });
        });
    }

    // 브랜드 상품 렌더링
    function renderTable(page = 1) {
        const container = document.querySelector(".product-list");
        container.innerHTML = ""; // 초기화

        // allProducts 배열을 사용해 필터링
        let filtered = allProducts.filter(p =>
            p.category === currentCategory &&
            (currentBrand === "all" || p.brand === currentBrand)
        );

        // 보여줄 상품 범위 계산
        const start = (page - 1) * pageSize;
        const end = start + pageSize;
        const itemsToShow = filtered.slice(start, end);

        // DOM 생성해서 추가
        itemsToShow.forEach(p => {
            const card = document.createElement("div");
            card.classList.add("product-card");
            card.dataset.category = p.category;
            card.dataset.brand = p.brand;

            // 백엔드 데이터 필드에 맞게 수정: price -> cost, img -> imgUrl
            card.innerHTML = `
            <img src="${p.imgUrl}" alt="${p.itemName}">
            <div class="product-name-box">
                <p class="product-name">${p.itemName}</p>
                <p class="product-price">${p.cost}P</p>
                <button class="buy-btn" data-price="${p.cost}" data-name="${p.itemName}">구매하기</button>
            </div>
        `;
            container.appendChild(card);
        });

        // 구매 버튼 이벤트 바인딩
        document.querySelectorAll(".buy-btn").forEach(btn => {
            btn.addEventListener("click", async () => {
                console.log("구매 버튼 클릭됨");

                // 로그인 체크
                if (!isLoggedIn) {
                    alert("로그인이 필요합니다.");
                    return;
                }

                // 상품 정보
                const priceText = btn.dataset.price.replace("P", "");
                const price = parseInt(priceText);
                const name = btn.dataset.name;

                console.log("구매 상품:", name, "가격:", price);

                // 구매 확인
                if (!confirm(`'${name}' 상품을 구매하시겠습니까? (차감 포인트: ${price}P)`)) {
                    return;
                }

                try {
                    console.log("구매 요청 전송 시작");

                    const requestData = {
                        productName: name,
                        price: price,
                        category: currentCategory,
                        brand: currentBrand
                    };

                    console.log("요청 데이터:", requestData);

                    const response = await fetch("/api/purchase", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        credentials: "include",
                        body: JSON.stringify(requestData)
                    });

                    console.log("구매 응답 상태:", response.status);

                    const result = await response.json();
                    console.log("구매 응답 데이터:", result);

                    if (result.success) {
                        alert(result.message);

                        // 포인트 업데이트
                        const userPointSpan = document.getElementById("userPoint");
                        userPointSpan.textContent = `| ${result.remainingPoint} P`;

                        console.log("구매 성공, 새로운 포인트:", result.remainingPoint);
                    } else {
                        alert("구매 실패: " + result.message);
                        console.log("구매 실패:", result.message);
                    }
                } catch (error) {
                    console.error("구매 요청 오류:", error);
                    alert("구매 처리 중 오류가 발생했습니다.");
                }
            });
        });

        // 페이징 다시 그리기
        renderPagination(filtered.length, page);

        // 현재 페이지 저장
        currentPage = page;
    }


    // 페이징 버튼
    function renderPagination(totalItems, currentPage) {
        const paginationDiv = document.getElementById("pagination");
        paginationDiv.innerHTML = "";

        const totalPages = Math.ceil(totalItems / pageSize);

        // ◀ 이전 버튼
        const prevBtn = document.createElement("button");
        prevBtn.textContent = "◀";
        prevBtn.disabled = currentPage === 1;
        prevBtn.addEventListener("click", () => renderTable(currentPage - 1));
        paginationDiv.appendChild(prevBtn);

        // 페이지 번호 버튼
        for (let i = 1; i <= totalPages; i++) {
            const btn = document.createElement("button");
            btn.textContent = i;
            if (i === currentPage) btn.classList.add("active");
            btn.addEventListener("click", () => renderTable(i));
            paginationDiv.appendChild(btn);
        }

        // ▶ 다음 버튼
        const nextBtn = document.createElement("button");
        nextBtn.textContent = "▶";
        nextBtn.disabled = currentPage === totalPages;
        nextBtn.addEventListener("click", () => renderTable(currentPage + 1));
        paginationDiv.appendChild(nextBtn);
    }

    // 이벤트 바인딩
    function bindEvents() {
        // 사이드바 카테고리 클릭
        document.querySelectorAll(".category-link").forEach(link => {
            link.addEventListener("click", e => {
                e.preventDefault();
                currentCategory = link.dataset.category;
                currentBrand = "all"; // 카테고리 바뀌면 브랜드는 전체로 초기화
                renderTitle();
                renderTable(1);
            });
        });

        // 브랜드 필터 클릭
        document.querySelectorAll(".brand-link").forEach(link => {
            link.addEventListener("click", e => {
                e.preventDefault();
                currentBrand = link.dataset.brand;
                renderTable(1);
            });
        });
    }

    // 새로 추가된 상품 목록을 서버에서 가져오는 함수
    async function fetchProducts() {
        try {
            const response = await fetch("/api/products");
            if (!response.ok) {
                throw new Error('상품 데이터를 가져오는 데 실패했습니다.');
            }
            const data = await response.json();
            // 백엔드에서 받은 products 배열을 allProducts에 할당
            allProducts = data.products;
        } catch (error) {
            console.error("상품 데이터를 불러오는 중 오류 발생:", error);
            allProducts = []; // 오류 발생 시 빈 배열로 초기화
        }
    }

    // 페이지 로드시 실행
    document.addEventListener("DOMContentLoaded", async function () {
        await checkLogin();
        await fetchProducts();
        bindEvents();
        renderTitle();
        renderTable(1); // 첫 페이지 출력
    });
</script>
</html>