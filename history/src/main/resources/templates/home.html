<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <title>역사 한 걸음</title>
    <link rel="stylesheet" href="/css/style.css">

    <script>
        function submitHiddenForm() {
            // 입력값 검증
            const email = document.getElementById('id').value;
            const password = document.getElementById('pw').value;
            const validationError = document.getElementById('validationError');

            if (!email || !password) {
                // 기존 서버 오류 메시지 숨기기
                hideServerErrorMessages();

                // JavaScript validation 메시지 표시
                validationError.style.display = 'block';
                return;
            }

            // 입력이 완료되면 validation 오류 메시지 숨기기
            validationError.style.display = 'none';

            // 보이는 input 값을 숨겨진 form으로 복사
            document.getElementById('hiddenEmail').value = email;
            document.getElementById('hiddenPassword').value = password;

            // 숨겨진 form 제출
            document.getElementById('hiddenLoginForm').submit();
        }

        function hideServerErrorMessages() {
            // 서버에서 온 오류 메시지들만 숨기기
            const serverErrors = document.querySelectorAll('.error-message-box p:not(#validationError)');
            serverErrors.forEach(error => {
                error.style.display = 'none';
            });
        }

        // Enter 키 이벤트 처리
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                submitHiddenForm();
            }
        }

        // 입력 필드에 값이 입력되기 시작하면 validation 오류 메시지 숨기기
        function clearValidationError() {
            const validationError = document.getElementById('validationError');
            if (validationError) {
                validationError.style.display = 'none';
            }
        }

        // 로그인 상태 확인 후 출석하기 페이지 이동
        function checkLoginAndAttend() {
            // 로그인 상태 확인 - DOM에서 로그인 상태를 체크
            const loginStatus = document.querySelector('#loginStatus li');
            const isLoggedIn = !loginStatus.querySelector('h3'); // Login 제목이 없으면 로그인 상태

            if (isLoggedIn) {
                // 로그인 상태면 출석 페이지로 이동
                window.location.href = '/attend';
            } else {
                // 비로그인 상태면 팝업 표시
                alert('로그인 해주세요.');
            }
        }
    </script>
</head>

<body>
<!-- 숨겨진 로그인 form -->
<form id="hiddenLoginForm" th:action="@{/user/login}" method="post" style="display: none;">
    <input type="text" name="email" id="hiddenEmail">
    <input type="password" name="password" id="hiddenPassword">
</form>

<div id="container">
    <header>
        <img src="/img/mainLg2.png" alt="메인 로고">
    </header>
    <div id="bgImg">
        <div id="mainScreen" class="carousel slide" data-ride="carousel">
            <ol class="carousel-indicators">
                <li data-target="#myCarousel" data-slide-to="0" class="active"></li>
                <li data-target="#myCarousel" data-slide-to="1"></li>
                <li data-target="#myCarousel" data-slide-to="2"></li>
            </ol>
            <div class="carousel-inner">
                <div class="item active">
                    <img src="/img/bg6.jpg" alt="bg6" style="width: 100%;">
                </div>
                <div class="item">
                    <img src="/img/bg5.jpg" alt="bg5" style="width: 100%;">
                </div>
                <div class="item">
                    <img src="/img/bg1.jpg" alt="bg1" style="width: 100%;">
                </div>
            </div>
            <!-- 슬라이드 버튼 -->
            <a class="left carousel-control" href="#mainScreen" data-slide="prev">
                <span class="glyphicon glyphicon-chevron-left"></span>
                <span class="sr-only">Previous</span>
            </a>
            <a class="right carousel-control" href="#mainScreen" data-slide="next">
                <span class="glyphicon glyphicon-chevron-right"></span>
                <span class="sr-only">Next</span>
            </a>
        </div>
    </div>

    <!-- main-content 컨테이너 추가 -->
    <div id="main-content">
        <!-- 두 줄의 버튼을 담는 컨테이너 -->
        <div id="buttons-container">
            <div id="box1">
                <div id="studyBox">
                    <a href="/board/topic" style="color: #333;">학습하기</a>
                </div>
                <div id="quizBox">
                    <a href="/quiz/topic" style="color: #333;">퀴즈풀기</a>
                </div>
                <div id="attendBox">
                    <a href="javascript:void(0);" onclick="checkLoginAndAttend()" style="color: #333;">출석하기</a>
                </div>
            </div>
            <div id="box2">
                <div id="pointBox">
                    <a href="/pointStore" style="color: #333;">포인트 상점</a>
                </div>
                <div id="faqBox">
                    <a href="/faq" style="color: #333;">FAQ</a>
                </div>
                <div id="noticeBox">
                    <a href="/notice" style="color: #333;">공지사항</a>
                </div>
            </div>
        </div>
        <!-- 로그인 box 부분 - 버튼 컨테이너 옆에 배치 -->
        <div id="loginBox">
            <div id="loginStatus">
                <ul>
                    <!-- 비로그인 상태 -->
                    <li th:if="${session.loginUser == null}" style="list-style: none;">
                        <h3>Login</h3>
                        <div id="inputRow">
                            <div id="inputBox">

                                <input type="text" name="email" id="id" placeholder="아이디를 입력해 주세요."
                                       onkeypress="handleKeyPress(event)">
                                <input type="password" name="password" id="pw" placeholder="비밀번호를 입력해 주세요."
                                       onkeypress="handleKeyPress(event)">
                            </div>
                            <button type="button" id="lgBox" onclick="submitHiddenForm()">로그인</button>
                        </div>
                        <div id="suRow">
                            <div id="suBox">
                                <a th:href="@{/user/add}" style="color: #333;">회원가입</a>
                            </div>
                        </div>
                        <!-- 로그인 오류 메시지 및 빈 공간 추가 -->
                        <div class="error-message-box">
                            <p th:if="${loginError == 'notFound'}" style="margin: 0;">존재하지 않는 아이디입니다.<br> 가입하시겠습니까?
                            </p>
                            <p th:if="${loginError == 'invalidPassword'}" style="margin: 0;">비밀번호가 틀렸습니다.</p>
                            <p id="validationError" style="margin: 0; color: red; display: none;">
                                아이디와 비밀번호를 모두 입력해주세요.
                            </p>
                        </div>
                    </li>
                    <!-- 로그인 상태 -->
                    <li th:unless="${session.loginUser == null}" style="list-style: none;">
                            <span th:text="${session.loginUser.name} + '님, 환영합니다!'"
                                  style="color: #333; font-weight: bold;"></span>
                        <br>
                        <!-- 사용자 유형에 따라 링크 표시 -->
                        <a th:if="${session.loginUser.userType == '관리자'}" th:href="@{/admin/users}"
                           class="login-link-btn admin">관리자 페이지</a>
                        <div th:if="${session.loginUser.userType == '일반유저'}" class="user-links-container">
                            <a th:href="@{/user/myPage}" class="login-link-btn user">마이페이지</a>
                        </div>
                        <a th:href="@{/user/logout}" class="login-link-btn logout">로그아웃</a>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <div id="tel">
        <ul>
            <li>대표전화: 042-222-2402</li>
            <li>주소: (34838) 대전 중구 중앙로121번길 20(방산빌딩 3층)</li>
            <li>운영시간: 평일 09:00 ~ 18:00 (주말·공휴일 휴무)</li>
            <li>© 2025 중등 역사 교육. All rights reserved.</li>
        </ul>
    </div>
</div>
</body>
</html>
