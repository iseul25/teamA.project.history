<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>퀴즈풀기</title>
    <link rel="stylesheet" href="/css/quizSolve.css"/>
</head>
<body>
<header>
    <a href="/"><img src="/img/mainLg2.png" alt="메인 로고"/></a>
    <ul>
        <li><a href="/board/topic">학습하기</a></li>
        <li><a href="/quiz/topic" class="active">퀴즈풀기</a></li>
        <li><a href="/attend">출석하기</a></li>
        <li><a href="/pointStore">포인트 상점</a></li>
        <li><a href="/faq">FAQ</a></li>
        <li><a href="/notice">공지사항</a></li>
    </ul>
    <div id="user" style="display:none;">
        <a href="/user/myPage" id="userName-link"> 님</a>
    </div>
</header>

<div id="container">
    <div class="quiz-wrapper">
        <div class="quiz-header">
            <div class="title-box">
                <span id="era-badge" class="badge-era" style="display:none;"></span>
                <div class="quiz-title"></div>
                <div class="questions-title" id="question-title">
                    문제
                    <span id="admin-badge" class="badge-admin" style="display:none;">
      관리자 모드
      <button id="open-edit-modal" type="button" style="margin-left:6px;">문항 수정</button>
    </span>
                </div>
            </div>

            <div class="quiz-number">
                <p>문제</p>
                <span id="current-question">1</span> /
                <span id="total-questions">10</span>

                <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"
                     id="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                    <div class="progress-text" id="progress-text"></div>
                </div>

                <div class="submit-btn-box">
                    <button id="submit-btn" style="display:none;">제출하기</button>
                    <button id="back-list-btn" style="display:none;">목록보기</button>
                </div>
            </div>
        </div>

        <div class="quizBox">
            <div class="content-title">
                <div class="questions-content">
                    <p id="question-text">문제 설명이 들어갑니다.</p>
                </div>
                <div class="question-image" id="question-image" style="display:none;">
                    <img src="" alt="문제 이미지"/>
                </div>
            </div>

            <div class="questions-options" id="options-box">
            </div>

            <div class="quiz-nav">
                <button id="prev-btn">◀ 이전</button>
                <div id="pagination"></div>
                <button id="next-btn">다음 ▶</button>
            </div>
        </div>
    </div>

    <div class="resultBox" id="result-box" style="display:none;">
        <h2>퀴즈 결과</h2>
        <div id="score-box">
            <p>총점: <span id="total-score">0</span> 점</p>
            <p>맞춘 개수: <span id="correct-count">0</span></p>
            <p>획득 포인트: <span id="earned-points">0</span>P</p>
            <p>수료 여부: <span id="pass-status">미수료</span></p>
        </div>
        <div id="answer-review">
            <h3>정답 확인</h3>
            <ul id="review-list"></ul>
        </div>
        <div class="result-btn-box">
            <button id="close-btn" class="close-btn">닫기</button>
            <button id="detail-btn" class="quiz-detail-btn">상세보기</button>
        </div>
    </div>
</div>

<div id="edit-modal-wrap" class="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="edit-modal-title">
        <h3 id="edit-modal-title">문항 수정</h3>
        <div class="grid">

            <label>질문</label>
            <textarea id="em-question" placeholder="질문"></textarea>

            <label>보기 1</label>
            <input id="em-item1" type="text" placeholder="보기 1"/>

            <label>보기 2</label>
            <input id="em-item2" type="text" placeholder="보기 2"/>

            <label>보기 3</label>
            <input id="em-item3" type="text" placeholder="보기 3"/>

            <label>보기 4</label>
            <input id="em-item4" type="text" placeholder="보기 4"/>

            <label>정답</label>
            <select id="em-answer">
                <option value="1">1번</option>
                <option value="2">2번</option>
                <option value="3">3번</option>
                <option value="4">4번</option>
            </select>

            <label>현재 이미지</label>
            <div>
                <img id="em-preview" class="img-preview" alt="미리보기"/>
                <div style="font-size:12px;color:#666;margin-top:6px;">이미지는 별도 저장됩니다.</div>
            </div>

            <label>이미지 변경</label>
            <input id="em-image" type="file" accept="image/*"/>
        </div>

        <div class="actions">
            <button id="em-cancel" type="button">닫기</button>
            <button id="em-save-text" type="button">텍스트 저장</button>
            <button id="em-save-image" type="button">이미지 저장</button>
        </div>
    </div>
</div>

<div id="footer">
    <ul>
        <li>대표전화: 042-222-2402</li>
        <li>주소: (34838) 대전 중구 중앙로121번길 20(방산빌딩 3층)</li>
        <li>운영시간: 평일 09:00 ~ 18:00 (주말·공휴일 휴무)</li>
        <li>© 2025 역사 한 걸음. All rights reserved.</li>
    </ul>
</div>

<script th:inline="javascript">
    const QUIZ_CATEGORY_ID = /*[[${quizCategoryId}]]*/ 0;
    const IS_ADMIN = /*[[${session.loginUser != null and session.loginUser.userType == '관리자'}]]*/ false;
</script>

<script>
    document.addEventListener('DOMContentLoaded', initQuiz);

    let reviewMode = false;

    async function initQuiz() {
        try {
            // 먼저 수료 여부 확인
            const checkResponse = await fetch(`/quiz/api/check-pass?quizCategoryId=${encodeURIComponent(QUIZ_CATEGORY_ID)}`, {
                credentials: 'include'
            });

            if (checkResponse.ok) {
                const checkData = await checkResponse.json();
                if (checkData.passed) {
                    alert('이미 수료한 퀴즈입니다. 재응시할 수 없습니다.');
                    location.href = '/quiz/topic';
                    return;
                }
            }

            const url = `/quiz/api/questions?quizCategoryId=${encodeURIComponent(QUIZ_CATEGORY_ID)}`;
            const res = await fetch(url, {credentials: 'include'});
            const raw = await res.text();

            if (!res.ok) {
                console.error('HTTP', res.status, raw);
                if (res.status === 401) {
                    alert('로그인이 필요합니다.');
                    location.href = '/login';
                } else {
                    alert(`문제를 불러오지 못했습니다. (HTTP ${res.status})`);
                }
                return;
            }
            if (!raw || !raw.trim()) {
                alert(`서버 응답 본문이 비어있습니다. (HTTP ${res.status})`);
                return;
            }

            let data;
            try {
                data = JSON.parse(raw);
            } catch (e) {
                console.error('JSON parse error:', e, raw);
                alert('서버 응답(JSON) 해석 실패');
                return;
            }

            console.log('원본 서버 데이터:', data);
            console.log('첫 번째 문제 상세:', data.questions[0]);

            if (data && Array.isArray(data.questions)) {
                data.questions = data.questions.map((q, i) => {
                    // ID 보정
                    const quizId = q.quizId ?? q.id ?? q.questionId ?? i + 1;

                    // 질문/이미지 키 보정: question/imgUrl 가 없으면 text/image 사용
                    const question = (q.question ?? q.text ?? '') || '';
                    const imgUrl = (q.imgUrl ?? q.image ?? '') || '';

                    // 보기 보정: item1~4 우선, 없으면 options(배열/객체)로 채움
                    let item1 = q.item1, item2 = q.item2, item3 = q.item3, item4 = q.item4;
                    if (item1 == null && item2 == null && item3 == null && item4 == null) {
                        if (Array.isArray(q.options)) {
                            [item1, item2, item3, item4] = q.options;
                        } else if (q.options && typeof q.options === 'object') {
                            ({item1, item2, item3, item4} = q.options);
                        }
                    }

                    // 정답 보정: 문자열이면 숫자로
                    let answer = q.answer ?? q.correct ?? q.correctAnswer;
                    if (answer != null) {
                        answer = Number(answer);
                        if (isNaN(answer)) {
                            console.warn(`문제 ${i + 1}의 정답값이 숫자가 아닙니다:`, q.answer);
                            answer = 1; // 기본값
                        }
                    } else {
                        console.warn(`문제 ${i + 1}에 정답이 없습니다.`);
                        answer = 1; // 기본값
                    }

                    return {...q, quizId, question, imgUrl, item1, item2, item3, item4, answer};
                });
                console.log('받은 데이터:', data.questions);
            } else {
                alert('등록된 문제가 없습니다.');
                return;
            }

            // 기대 형태: { title, questions:[{ quizId, question, imgUrl, item1..item4, answer, ... }] }
            // 혹시 title 없으면 빈값 표시
            document.querySelector('.quiz-title').textContent = (data && data.title) ? data.title : '';

            const questions = (data && Array.isArray(data.questions)) ? data.questions : [];
            if (questions.length === 0) {
                alert('등록된 문제가 없습니다.');
                return;
            }

            // 화면상 총 문항 수 반영
            document.getElementById('total-questions').textContent = questions.length;

            // 상태 보관
            window.__quiz__ = {list: questions, idx: 0, picks: new Map()};

            renderCurrent();
            renderPagination();

            // 버튼 바인딩
            document.getElementById('prev-btn').onclick = () => move(-1);
            document.getElementById('next-btn').onclick = () => move(+1);
            document.getElementById('submit-btn').onclick = submitQuiz;
            document.getElementById('close-btn').onclick = () => location.href = '/quiz/topic';
            document.getElementById('detail-btn').onclick = showDetailView;
            document.getElementById('back-list-btn').onclick = () => location.href = '/quiz/topic';

            // 관리자 모드
            if (IS_ADMIN) {
                document.getElementById('admin-badge').style.display = 'inline-flex';
                const editBtn = document.getElementById('open-edit-modal');
                if (editBtn) {
                    editBtn.onclick = openEditModal;
                }
            }

        } catch (err) {
            console.error(err);
            alert('알 수 없는 오류로 문제 로딩 실패');
        }
    }

    function renderCurrent() {
        const st = window.__quiz__;
        const q = st.list[st.idx];
        if (!q) return;

        // 진행도
        document.getElementById('current-question').textContent = st.idx + 1;
        const rate = Math.round(((st.idx + 1) / st.list.length) * 100);
        document.getElementById('progress-fill').style.width = rate + '%';
        document.getElementById('progress-text').textContent = `문제 ${st.idx + 1} / ${st.list.length} · ${rate}% 완료`;

        // ==== DB 컬럼명에 맞춤: question / imgUrl ====
        document.getElementById('question-text').textContent = q.question || '';
        const imgWrap = document.getElementById('question-image');
        const imgEl = imgWrap.querySelector('img');
        if (q.imgUrl) {
            imgEl.src = q.imgUrl;
            imgWrap.style.display = 'block';
        } else {
            imgEl.removeAttribute('src');
            imgWrap.style.display = 'none';
        }

        // 보기 렌더
        const box = document.getElementById('options-box');
        box.innerHTML = '';

        // ==== DB 기준 보기 구성(item1~item4) → 배열 ====
        let optionsArray = [q.item1, q.item2, q.item3, q.item4].filter(v => v !== undefined && v !== null);
        // 예외적으로 서버가 options 배열/객체를 주면 백업 플랜
        if (optionsArray.length === 0) {
            if (Array.isArray(q.options)) {
                optionsArray = q.options;
            } else if (q.options && typeof q.options === 'object') {
                optionsArray = [q.options.item1, q.options.item2, q.options.item3, q.options.item4];
            }
        }

        const correctIndex = Number(q.answer); // ==== 정답 숫자형 ====

        optionsArray.forEach((opt, i) => {
            const v = i + 1;
            const picked = st.picks.get(q.quizId);
            const checked = (picked === v) ? 'checked' : '';
            const disabled = reviewMode ? 'disabled' : '';

            let classes = [];
            if (reviewMode) {
                if (v === correctIndex) classes.push('correct-answer');
                if (picked === v && v !== correctIndex) classes.push('wrong-answer');
            }

            box.insertAdjacentHTML('beforeend', `
            <label class="${classes.join(' ')}">
                <input type="radio" name="answer" value="${v}" ${checked} ${disabled}>
                <span>${opt ?? ''}</span>
            </label><br/>
        `);
        });

        if (!reviewMode) {
            box.querySelectorAll('input[name="answer"]').forEach(r => {
                r.addEventListener('change', e => {
                    st.picks.set(q.quizId, Number(e.target.value)); // ==== 숫자형으로 저장 ====
                    updateSubmitButton();
                });
            });
        }

        updateSubmitButton();
        renderPagination();
    }

    function renderPagination() {
        const st = window.__quiz__;
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';

        st.list.forEach((q, i) => {
            const btn = document.createElement('button');
            btn.textContent = i + 1;
            if (i === st.idx) btn.classList.add('active');
            btn.onclick = () => {
                st.idx = i;
                renderCurrent();
            };
            pagination.appendChild(btn);
        });
    }

    function move(d) {
        const st = window.__quiz__;
        const ni = st.idx + d;
        if (ni < 0 || ni >= st.list.length) return;
        st.idx = ni;
        renderCurrent();
    }

    function updateSubmitButton() {
        const st = window.__quiz__;
        const allAnswered = st.list.every(q => st.picks.has(q.quizId));

        if (reviewMode) {
            document.getElementById('submit-btn').style.display = 'none';
            if (st.idx === st.list.length - 1) {
                document.getElementById('back-list-btn').style.display = 'block';
            } else {
                document.getElementById('back-list-btn').style.display = 'none';
            }
        } else {
            document.getElementById('back-list-btn').style.display = 'none';
            if (st.idx === st.list.length - 1 && allAnswered) {
                document.getElementById('submit-btn').style.display = 'block';
            } else {
                document.getElementById('submit-btn').style.display = 'none';
            }
        }
    }

    async function submitQuiz() {
        const st = window.__quiz__;

        // 답안 데이터 구성
        const answers = [];
        st.list.forEach(q => {
            const userAnswer = st.picks.get(q.quizId);
            if (userAnswer) {
                answers.push({
                    quizId: q.quizId,
                    picked: userAnswer
                });
            }
        });

        try {
            // 서버로 제출
            const response = await fetch('/quiz/api/submit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({
                    quizCategoryId: QUIZ_CATEGORY_ID,
                    answers: answers
                })
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('서버 응답 오류:', errorText);
                alert('제출 중 오류가 발생했습니다.');
                return;
            }

            const result = await response.json();
            console.log('서버 응답:', result);

            // 결과 화면 표시
            document.getElementById('total-score').textContent = result.totalScore || 0;
            document.getElementById('correct-count').textContent = `${result.correctCount || 0} / ${st.list.length}`;
            document.getElementById('earned-points').textContent = result.earnedPoints || 0;
            document.getElementById('pass-status').textContent = result.pass ? '수료' : '미수료';

            // 리뷰 리스트 생성
            const reviewList = document.getElementById('review-list');
            reviewList.innerHTML = '';

            if (result.review && Array.isArray(result.review)) {
                result.review.forEach((r, i) => {
                    const icon = r.correct ? '✅' : '❌';
                    const text = r.correct ? '정답' : '오답';
                    reviewList.innerHTML += `<li>문제 ${i + 1}: ${text} ${icon} (정답: ${r.correctAnswer || '정보 없음'})</li>`;
                });
            }

            document.querySelector('.quiz-wrapper').style.display = 'none';
            document.getElementById('result-box').style.display = 'block';
            window.scrollTo({top: 0, behavior: 'smooth'});

        } catch (error) {
            console.error('제출 오류:', error);
            alert('제출 중 오류가 발생했습니다: ' + error.message);
        }
    }

    function showDetailView() {
        reviewMode = true;
        document.getElementById('result-box').style.display = 'none';

        const wrapper = document.querySelector('.quiz-wrapper');
        wrapper.style.display = 'block';
        wrapper.classList.add('review-mode');

        const st = window.__quiz__;
        st.idx = 0;
        renderCurrent();
        window.scrollTo({top: 0, behavior: 'smooth'});
    }

    // ==================== 관리자 수정 모달 기능 ====================

    function openEditModal() {
        const st = window.__quiz__;
        const q = st.list[st.idx];
        if (!q) return;

        // quizId는 내부적으로만 사용 (화면에 표시하지 않음)
        window.__currentEditQuizId__ = q.quizId;

        // 현재 문제 데이터를 모달에 채우기
        document.getElementById('em-question').value = q.question || '';
        document.getElementById('em-item1').value = q.item1 || '';
        document.getElementById('em-item2').value = q.item2 || '';
        document.getElementById('em-item3').value = q.item3 || '';
        document.getElementById('em-item4').value = q.item4 || '';
        document.getElementById('em-answer').value = q.answer || '1';

        // 이미지 미리보기
        const preview = document.getElementById('em-preview');
        if (q.imgUrl) {
            preview.src = q.imgUrl;
            preview.style.display = 'block';
        } else {
            preview.src = '';
            preview.style.display = 'none';
        }

        // 모달 표시
        const modalWrap = document.getElementById('edit-modal-wrap');
        if (!modalWrap) {
            console.error('edit-modal-wrap 요소를 찾을 수 없습니다.');
            return;
        }
        modalWrap.style.display = 'flex';

        // 버튼 이벤트 연결 (중복 방지)
        const cancelBtn = document.getElementById('em-cancel');
        const saveTextBtn = document.getElementById('em-save-text');
        const saveImageBtn = document.getElementById('em-save-image');
        const imageInput = document.getElementById('em-image');

        if (cancelBtn) {
            const newCancelBtn = cancelBtn.cloneNode(true);
            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
            newCancelBtn.onclick = closeEditModal;
        }

        if (saveTextBtn) {
            const newSaveTextBtn = saveTextBtn.cloneNode(true);
            saveTextBtn.parentNode.replaceChild(newSaveTextBtn, saveTextBtn);
            newSaveTextBtn.onclick = saveQuizText;
        }

        if (saveImageBtn) {
            const newSaveImageBtn = saveImageBtn.cloneNode(true);
            saveImageBtn.parentNode.replaceChild(newSaveImageBtn, saveImageBtn);
            newSaveImageBtn.onclick = saveQuizImage;
        }

        // 이미지 파일 선택 시 미리보기
        if (imageInput) {
            const newImageInput = imageInput.cloneNode(true);
            imageInput.parentNode.replaceChild(newImageInput, imageInput);
            newImageInput.addEventListener('change', e => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = ev => {
                        preview.src = ev.target.result;
                        preview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
    }

    function closeEditModal() {
        const modalWrap = document.getElementById('edit-modal-wrap');
        if (modalWrap) {
            modalWrap.style.display = 'none';
        }
        const imageInput = document.getElementById('em-image');
        if (imageInput) {
            imageInput.value = '';
        }
    }

    async function saveQuizText() {
        const quizId = window.__currentEditQuizId__;
        const question = document.getElementById('em-question').value.trim();
        const item1 = document.getElementById('em-item1').value.trim();
        const item2 = document.getElementById('em-item2').value.trim();
        const item3 = document.getElementById('em-item3').value.trim();
        const item4 = document.getElementById('em-item4').value.trim();
        const answer = document.getElementById('em-answer').value;

        if (!question || !item1 || !item2 || !item3 || !item4) {
            alert('모든 필드를 입력해주세요.');
            return;
        }

        try {
            const response = await fetch(`/quiz/api/admin/quiz/${quizId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({
                    question: question,
                    item1: item1,
                    item2: item2,
                    item3: item3,
                    item4: item4,
                    answer: parseInt(answer)
                })
            });

            if (!response.ok) {
                throw new Error('저장 실패');
            }

            const result = await response.json();
            if (result.success) {
                alert('문제가 수정되었습니다.');

                // 현재 화면의 데이터 업데이트
                const st = window.__quiz__;
                const q = st.list[st.idx];
                q.question = question;
                q.item1 = item1;
                q.item2 = item2;
                q.item3 = item3;
                q.item4 = item4;
                q.answer = parseInt(answer);

                renderCurrent();
                closeEditModal();
            } else {
                alert('저장 실패: ' + (result.message || '알 수 없는 오류'));
            }
        } catch (error) {
            console.error('저장 오류:', error);
            alert('저장 중 오류가 발생했습니다.');
        }
    }

    async function saveQuizImage() {
        const quizId = window.__currentEditQuizId__;
        const fileInput = document.getElementById('em-image');
        const file = fileInput.files[0];

        if (!file) {
            alert('이미지 파일을 선택해주세요.');
            return;
        }

        try {
            // 1. 이미지 업로드
            const formData = new FormData();
            formData.append('file', file);

            const uploadResponse = await fetch('/quiz/api/admin/image', {
                method: 'POST',
                credentials: 'include',
                body: formData
            });

            if (!uploadResponse.ok) {
                throw new Error('이미지 업로드 실패');
            }

            const uploadResult = await uploadResponse.json();
            if (!uploadResult.success || !uploadResult.url) {
                throw new Error('이미지 URL을 받지 못했습니다.');
            }

            // 2. 문제 정보에 이미지 URL 업데이트
            const updateResponse = await fetch(`/quiz/api/admin/quiz/${quizId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({
                    imgUrl: uploadResult.url
                })
            });

            if (!updateResponse.ok) {
                throw new Error('이미지 URL 저장 실패');
            }

            const updateResult = await updateResponse.json();
            if (updateResult.success) {
                alert('이미지가 저장되었습니다.');

                // 현재 화면의 데이터 업데이트
                const st = window.__quiz__;
                const q = st.list[st.idx];
                q.imgUrl = uploadResult.url;

                // 미리보기 업데이트
                const preview = document.getElementById('em-preview');
                preview.src = uploadResult.url;
                preview.style.display = 'block';

                renderCurrent();

                // 파일 입력 초기화
                fileInput.value = '';
            } else {
                alert('저장 실패: ' + (updateResult.message || '알 수 없는 오류'));
            }
        } catch (error) {
            console.error('이미지 저장 오류:', error);
            alert('이미지 저장 중 오류가 발생했습니다: ' + error.message);
        }
    }
</script>
</body>
</html>