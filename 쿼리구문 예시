쿼리구문 예시(숫자 및 ''안의 단어는 예시입니다. -- 및 /* */ 안의 항목은 설명용이라 실제 구문에 반영되지 않습니다.)

-- 퀴즈의 각 항목 별 점수 배정
UPDATE quiz_attempt
SET quizScore = CASE
    WHEN quizId = 1 THEN 2
    WHEN quizId = 2 THEN 3
    WHEN quizId IN (3, 4) THEN 5
    ELSE quizScore -- 다른 경우 기존 값을 유지
END
WHERE quizId IN (1, 2, 3, 4);


-- 퀴즈의 각 항목 별 정답 배정
UPDATE quiz_attempt
SET answer = CASE
    WHEN quizId = 1 THEN 1
    WHEN quizId = 2 THEN 4
    WHEN quizId = 3 THEN 3
    WHEN quizId = 4 THEN 4
    ELSE answer -- 다른 경우 기존 값을 유지
END
WHERE quizId IN (1, 2, 3, 4);

-- 퀴즈 각 항목 별 정답, 오답 배정
UPDATE quiz_attempt
SET correct = CASE
    WHEN selected = answer THEN '정답'
    ELSE '오답'
END;

-- quiz_attempt의 correct 항목이 '정답'인 경우에만 해당 항목의 quizScore 점수를 합산하여 quiz_score 테이블의 score 항목에 기입
UPDATE quiz_score qs/*(=quiz_score)*/
JOIN (
    SELECT
        qa/*(=quiz_attempt)*/.userId,
        SUM(qa.quizScore) AS total_score
    FROM
        quiz_attempt qa
    WHERE
        qa.correct = '정답'
    GROUP BY
        qa.userId
) AS sub ON qs.userId = sub.userId
SET
    qs.score = sub.total_score;
    
    
/* score의 10배로 pointScore 기입*/
UPDATE quiz_score
SET pointScore = score * 10
WHERE userId IN (2, 3, 5);


/*상점이용 생성*/
INSERT INTO point_transactions (userId, attendanceId, itemId, scoreId, reason) 
VALUES (2, NULL, 1, NULL, '상점이용');

INSERT INTO point_transactions (userId, attendanceId, itemId, scoreId, reason) 
VALUES (3, NULL, 2, NULL, '상점이용');

INSERT INTO point_transactions (userId, attendanceId, itemId, scoreId, reason) 
VALUES (5, NULL, 3, NULL, '상점이용');

/*상점이용에 따른 포인트 차감*/
UPDATE point_transactions pt
SET pointChange = - (SELECT cost FROM point_shop WHERE itemId = pt.itemId)
WHERE pt.itemId IS NOT NULL
  AND pt.attendanceId IS NULL
  AND pt.scoreId IS NULL;
  
  
/*출석체크 생성*/
INSERT INTO point_transactions (userId, attendanceId, itemId, scoreId, reason) 
VALUES (2, 918, NULL, NULL, '출석체크');

INSERT INTO point_transactions (userId, attendanceId, itemId, scoreId, reason) 
VALUES (3, 919, NULL, NULL, '출석체크');

INSERT INTO point_transactions (userId, attendanceId, itemId, scoreId, reason) 
VALUES (5, 920, NULL, NULL, '출석체크');

/*출석체크에 따른 포인트 적립*/
UPDATE point_transactions pt
SET pointChange = (SELECT pointAdd FROM user_attendance WHERE attendanceId = pt.attendanceId)
WHERE pt.attendanceId IS NOT NULL
  AND pt.itemId IS NULL
  AND pt.scoreId IS NULL;
  
  
/* point_transactions 테이블에 퀴즈응시 생성*/
INSERT INTO point_transactions (userId, attendanceId, itemId, scoreId, reason) 
VALUES (2, NULL, NULL, 7, '퀴즈응시');

INSERT INTO point_transactions (userId, attendanceId, itemId, scoreId, reason) 
VALUES (3, NULL, NULL, 8, '퀴즈응시');

INSERT INTO point_transactions (userId, attendanceId, itemId, scoreId, reason) 
VALUES (5, NULL, NULL, 9, '퀴즈응시');

/*퀴즈응시에 따른 포인트 적립*/
UPDATE point_transactions pt
SET pointChange = (SELECT pointScore FROM quiz_score WHERE scoreId = pt.scoreId)
WHERE pt.scoreId IS NOT NULL
  AND pt.itemId IS NULL
  AND pt.attendanceId IS NULL;

-- 2번 유저의 totalPoint를 업데이트
UPDATE points
SET totalPoint = totalPoint + (SELECT pointChange FROM point_transactions WHERE transactionId = 17)
WHERE userId = 2;

UPDATE points
SET totalPoint = totalPoint + (SELECT pointChange FROM point_transactions WHERE transactionId = 20)
WHERE userId = 2;

UPDATE points
SET totalPoint = totalPoint + (SELECT pointChange FROM point_transactions WHERE transactionId = 23)
WHERE userId = 2;

-- 3번 유저의 totalPoint를 모두 업데이트
UPDATE points
SET totalPoint = totalPoint + (
    SELECT SUM(pointChange)
    FROM point_transactions
    WHERE transactionId IN (18, 21, 24)
)
WHERE userId = 3;

-- 5번 유저의 totalPoint를 모두 업데이트
UPDATE points
SET totalPoint = totalPoint + (
    SELECT SUM(pointChange)
    FROM point_transactions
    WHERE transactionId IN (19, 22, 25)
)
WHERE userId = 5;


-- (비효율적)2번 유저의 출석기록 추가와 그에 따른 포인트 적립
INSERT INTO user_attendance (userId, pointAdd) VALUES (2, 10);

INSERT INTO point_transactions (userId, attendanceId, itemId, scoreId, reason) 
VALUES (2, 922, NULL, NULL, '출석체크');

UPDATE point_transactions pt
SET pointChange = (SELECT pointAdd FROM user_attendance WHERE attendanceId = pt.attendanceId)
WHERE pt.attendanceId IS NOT NULL
  AND pt.itemId IS NULL
  AND pt.scoreId IS NULL;
  
UPDATE points
SET totalPoint = totalPoint + (SELECT pointChange FROM point_transactions WHERE transactionId = 26)
WHERE userId = 2;


-- 3번 유저의 출석기록 추가와 그에 따른 포인트 적립
INSERT INTO user_attendance (userId, pointAdd) VALUES (3, 10);

INSERT INTO point_transactions (userId, attendanceId, itemId, scoreId, reason, pointChange) 
SELECT 3, 923, NULL, NULL, '출석체크', pointAdd
FROM user_attendance
WHERE attendanceId = 923;

UPDATE points
SET totalPoint = totalPoint + (SELECT pointChange FROM point_transactions WHERE transactionId = 27)
WHERE userId = 3;

-- 5번 유저의 출석기록 추가와 그에 따른 포인트 적립
INSERT INTO user_attendance (userId, pointAdd) VALUES (5, 10);

INSERT INTO point_transactions (userId, attendanceId, itemId, scoreId, reason, pointChange) 
SELECT 5, 924, NULL, NULL, '출석체크', pointAdd
FROM user_attendance
WHERE attendanceId = 924;

UPDATE points
SET totalPoint = totalPoint + (SELECT pointChange FROM point_transactions WHERE transactionId = 28)
WHERE userId = 5;


-- 2번 유저의 포인트 총량과 사용내역 찾기
SELECT p/*(=points)*/.totalPoint, pt/*(=point_transactions)*/.*
FROM points p
JOIN point_transactions pt ON p.userId = pt.userId
WHERE p.userId = 2;
