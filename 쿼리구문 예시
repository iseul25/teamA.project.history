-- 1번 관리자가 선사시대 제1회 퀴즈문항의 하위 10개의 퀴즈 생성(quiz 테이블에 생성)

/*1번 관리자가 선사시대 제1회 퀴즈문항 생성*/
INSERT INTO quiz_category (userId, quizType, quizListName)
VALUES (1, '선사시대', '제1회 퀴즈문항');

/*하위 10개 퀴즈 생성*/
INSERT INTO quiz (quizCategoryId, imgUrl, question, item1, item2, item3, item4, answer, quizScore) 
VALUES (
1, NULL/*이미지 링크가 없으니 NULL로 대체*/, '대한민국의 수도는 어디일까요?', '서울', '부산', '인천', '대구',
1/*정답은 선택지 1인 '서울'*/, 10/* 퀴즈에 10점배정*/);


-- 41번 유저가 n시대 제n회 퀴즈문항에 응시하여 답변을 제출함(quiz_attempt 테이블에 답변 저장, 해당 답변 제출 이후 1번 트리거 활성화 -> 이후 2번 트리거 활성화)
INSERT INTO quiz_attempt (userId, quizCategoryId, quizId, selected, attemptAt)
VALUES
  (41, 1, 1, 1, NOW()),
  (41, 1, 2, 2, NOW()),
  (41, 1, 3, 3, NOW()),
  (41, 1, 4, 4, NOW()),
  (41, 1, 5, 3, NOW()),
  (41, 1, 6, 2, NOW()),
  (41, 1, 7, 1, NOW()),
  (41, 1, 8, 2, NOW()),
  (41, 1, 9, 3, NOW()),
  (41, 1, 10, 4, NOW()); /*quizId 1~10까지 n(선사)시대 제n(1)회 퀴즈문항*/
  

-- (1번 트리거로 대체함)41번 유저가 낸 답변을 각 항목별로 채점(quiz_attempt 테이블에 채점기록,)
UPDATE quiz_attempt qa
JOIN quiz q ON qa.quizId = q.quizId
SET qa.earnedScore = CASE
    WHEN q.answer = qa.selected THEN q.quizScore
    ELSE 0
END
WHERE qa.userId = 41;


-- (2번 트리거로 대체함)41번 유저가 선사시대 제1회 퀴즈문항에서 맞은 총점 및 환산 포인트 생성
INSERT INTO quiz_score (quizCategoryId, userId, totalScore,earnedPoint)
VALUES (
    1, 41,
    (
        SELECT SUM(earnedScore)
        FROM quiz_attempt
        WHERE userId = 41 AND quizCategoryId = 1
    ),
    (
        SELECT SUM(earnedScore) * 1
        FROM quiz_attempt
        WHERE userId = 41 AND quizCategoryId = 1
    )
);

/*points 테이블에 상점이용 생성*/
INSERT INTO points (userId, attendanceId, itemId, scoreId) 
VALUES (2, NULL, 1, NULL);

INSERT INTO points (userId, attendanceId, itemId, scoreId) 
VALUES (3, NULL, 2, NULL);

INSERT INTO points (userId, attendanceId, itemId, scoreId) 
VALUES (5, NULL, 3, NULL);

/*상점이용에 따른 포인트 차감*/
UPDATE points pt
SET pointChange = - (SELECT cost FROM point_shop WHERE itemId = pt.itemId)
WHERE pt.itemId IS NOT NULL
  AND pt.attendanceId IS NULL
  AND pt.scoreId IS NULL;
  
  
/* points 테이블에 출석체크 생성*/
INSERT INTO point_transactions (userId, attendanceId, itemId, scoreId) 
VALUES (2, 918, NULL, NULL);

INSERT INTO points (userId, attendanceId, itemId, scoreId) 
VALUES (3, 919, NULL, NULL);

INSERT INTO points (userId, attendanceId, itemId, scoreId) 
VALUES (5, 920, NULL, NULL);

/*출석체크에 따른 포인트 적립*/
UPDATE points pt
SET pointChange = (SELECT pointAdd FROM user_attendance WHERE attendanceId = pt.attendanceId)
WHERE pt.attendanceId IS NOT NULL
  AND pt.itemId IS NULL
  AND pt.scoreId IS NULL;
  
  
/* points 테이블에 퀴즈응시 생성*/
INSERT INTO points (userId, attendanceId, itemId, scoreId) 
VALUES (2, NULL, NULL, 7);

INSERT INTO points (userId, attendanceId, itemId, scoreId) 
VALUES (3, NULL, NULL, 8);

INSERT INTO points (userId, attendanceId, itemId, scoreId) 
VALUES (5, NULL, NULL, 9);

/*퀴즈응시에 따른 포인트 적립*/
UPDATE points pt
SET pointChange = (SELECT earnedPoint FROM quiz_score WHERE scoreId = pt.scoreId)
WHERE pt.scoreId IS NOT NULL
  AND pt.itemId IS NULL
  AND pt.attendanceId IS NULL;
